# –ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã AquaFlora WhatsApp Bot

## üîç –ò–∑—É—á–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã –≤ –∫–æ–¥–µ

### 1. –õ–∏–º–∏—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞

**–û—Å–Ω–æ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã:**
- **50 —Å–æ–æ–±—â–µ–Ω–∏–π** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `message_processor.py` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è AI
- **100 —Å–æ–æ–±—â–µ–Ω–∏–π** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `message_repository.py` –∫–∞–∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ª–∏–º–∏—Ç
- **10 —Å–æ–æ–±—â–µ–Ω–∏–π** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è:**
```python
# message_processor.py
conversation_history = await self.message_service.get_conversation_history_for_ai_by_sender(
    sender_id, session_id, limit=50
)

# message_repository.py  
async def get_conversation_history_by_sender(self, sender_id: str, session_id: str, limit: int = 100)

# –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
def add_message_with_transaction_sync(self, message: Message, limit: int = 10)
```

### 2. –õ–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è AI

**–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `ai_service.py`:**

```python
# –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å Gemini 2.5 Flash
generation_config=GenerationConfig(
    temperature=0.7,
    top_p=0.9,
    top_k=40,
    max_output_tokens=8192  # ‚Üê –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –õ–ò–ú–ò–¢
)

# –ú–æ–¥–µ–ª—å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞
generation_config=GenerationConfig(
    temperature=0.1,
    top_p=1,
    top_k=1,
    max_output_tokens=200  # ‚Üê –ú–ê–õ–ï–ù–¨–ö–ò–ô –õ–ò–ú–ò–¢
)

# –ú–æ–¥–µ–ª—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
generation_config=GenerationConfig(
    temperature=0.3,
    top_p=1,
    top_k=1,
    max_output_tokens=4096  # ‚Üê –°–†–ï–î–ù–ò–ô –õ–ò–ú–ò–¢
)
```

### 3. –õ–∏–º–∏—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**GCloud –ª–æ–≥–∏:**
- **1000 –∑–∞–ø–∏—Å–µ–π** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ª–æ–≥–æ–≤
- **5000 –∑–∞–ø–∏—Å–µ–π** - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

## üìä –†–µ–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:

1. **–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:** –º–∞–∫—Å–∏–º—É–º 50-100 —Å–æ–æ–±—â–µ–Ω–∏–π
2. **–í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã:** –º–∞–∫—Å–∏–º—É–º 8192 —Ç–æ–∫–µ–Ω–∞
3. **–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:** ~2,474 —Ç–æ–∫–µ–Ω–∞ (–Ω–æ–≤—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

### –†–∞—Å—á–µ—Ç –¥–ª—è Gemini 2.0 Flash (128,000 —Ç–æ–∫–µ–Ω–æ–≤):

```
–î–æ—Å—Ç—É–ø–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: 128,000 —Ç–æ–∫–µ–Ω–æ–≤
- –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: 2,474 —Ç–æ–∫–µ–Ω–∞
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø–∞—Å (20%): 25,600 —Ç–æ–∫–µ–Ω–æ–≤
= –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏: ~99,926 —Ç–æ–∫–µ–Ω–æ–≤
```

### –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–µ–∫—É—â–∏–º–∏ –ª–∏–º–∏—Ç–∞–º–∏:

**–°–∏—Å—Ç–µ–º–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –æ–∫–Ω–∞!**

- **–¢–µ–∫—É—â–∏–π –ª–∏–º–∏—Ç:** 50-100 —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç:** ~1000-2000 —Å–æ–æ–±—â–µ–Ω–∏–π (–ø—Ä–∏ —Å—Ä–µ–¥–Ω–µ–º —Ä–∞–∑–º–µ—Ä–µ 50-100 —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏

```python
# –í message_processor.py –∏–∑–º–µ–Ω–∏—Ç—å:
limit=50 ‚Üí limit=200  # –∏–ª–∏ –±–æ–ª—å—à–µ

# –í message_repository.py –∏–∑–º–µ–Ω–∏—Ç—å:
limit: int = 100 ‚Üí limit: int = 500
```

### 2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ª–∏–º–∏—Ç—ã

```python
def calculate_optimal_history_limit(system_prompt_tokens: int, max_context: int = 128000) -> int:
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–º–µ—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞"""
    available_tokens = max_context - system_prompt_tokens - (max_context * 0.2)  # 20% –∑–∞–ø–∞—Å
    estimated_tokens_per_message = 75  # —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
    return int(available_tokens / estimated_tokens_per_message)
```

### 3. –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è

```python
async def get_adaptive_conversation_history(sender_id: str, session_id: str) -> List[Dict]:
    """–ü–æ–ª—É—á–∞–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞"""
    system_prompt_size = len(get_system_prompt()) * 1.3  # –ø—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≤ —Ç–æ–∫–µ–Ω–∞—Ö
    optimal_limit = calculate_optimal_history_limit(system_prompt_size)
    return await get_conversation_history_by_sender(sender_id, session_id, limit=optimal_limit)
```

## üìà –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã vs –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ–∫—É—â–∏–π –ª–∏–º–∏—Ç | –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç | –£–≤–µ–ª–∏—á–µ–Ω–∏–µ |
|-----------|---------------|-------------------|------------|
| –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ | 50-100 —Å–æ–æ–±—â–µ–Ω–∏–π | 500-1000 —Å–æ–æ–±—â–µ–Ω–∏–π | **5-10x** |
| –í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã | 8192 | 8192 | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç | 2474 —Ç–æ–∫–µ–Ω–∞ | 2474 —Ç–æ–∫–µ–Ω–∞ | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

1. **–õ—É—á—à–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:** AI –±—É–¥–µ—Ç –≤–∏–¥–µ—Ç—å –±–æ–ª—å—à–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
2. **–ë–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:** –£—á–µ—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
3. **–ú–µ–Ω—å—à–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π:** AI –Ω–µ –±—É–¥–µ—Ç –∑–∞–±—ã–≤–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ—à–µ–Ω–∏—è
4. **–õ—É—á—à–∞—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è:** –ë–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ 5-10% –æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –æ–∫–Ω–∞ Gemini 2.0 Flash!**

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –≤ 5-10 —Ä–∞–∑ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –º–æ–¥–µ–ª–∏. 