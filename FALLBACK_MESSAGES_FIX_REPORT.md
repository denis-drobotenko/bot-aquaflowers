# –û—Ç—á—ë—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ fallback-—Å–æ–æ–±—â–µ–Ω–∏–π

## üö® –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ fallback-—Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞:
```
"–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. üå∏"
```

**–ü—Ä–∏—á–∏–Ω—ã:**
1. AI –≤–æ–∑–≤—Ä–∞—â–∞–ª –∫–æ–º–∞–Ω–¥—ã –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
2. AI –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø—É—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã
3. –û—à–∏–±–∫–∏ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥
4. –û—à–∏–±–∫–∏ –≤ AI —Å–µ—Ä–≤–∏—Å–µ

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. MessageProcessor (`src/services/message_processor.py`)

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- **–£–±—Ä–∞–ª fallback-—Å–æ–æ–±—â–µ–Ω–∏—è** - —Ç–µ–ø–µ—Ä—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ù–ï –ø–æ–ª—É—á–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫** - –≤—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º—É Errors –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- **–í–æ–∑–≤—Ä–∞—Ç True** - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `True` –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å fallback

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

#### `_send_ai_response()`
```python
# –ë—ã–ª–æ: –æ—Ç–ø—Ä–∞–≤–∫–∞ fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
if not success:
    user_lang = await self.session_service.get_user_language(sender_id, session_id)
    error_messages = self._get_error_messages(user_lang)
    await self._send_text_message(sender_id, error_messages['ru'], session_id)

# –°—Ç–∞–ª–æ: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ fallback
if not has_text and not has_command:
    await self.error_service.log_error(...)
    return True  # –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º fallback
```

#### `_process_ai()`
```python
# –ë—ã–ª–æ: –≤–æ–∑–≤—Ä–∞—Ç fallback-—Å–æ–æ–±—â–µ–Ω–∏—è
except Exception as e:
    error_messages = self._get_error_messages(user_lang)
    return AIResponse(error_messages['ru'], error_messages['en'], error_messages['th'], None)

# –°—Ç–∞–ª–æ: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
except Exception as e:
    await self.error_service.log_error(...)
    return AIResponse("", "", "", None)  # –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
```

#### `process_user_message()`
```python
# –ë—ã–ª–æ: –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—Ö–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ fallback
success = await self._send_ai_response(ai_response, sender_id, session_id, wamid, 0)
if not success:
    # –û—Ç–ø—Ä–∞–≤–∫–∞ fallback
    return success

# –°—Ç–∞–ª–æ: –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—Ç True
await self._send_ai_response(ai_response, sender_id, session_id, wamid, 0)
return True  # –í—Å–µ–≥–¥–∞ —É—Å–ø–µ—Ö
```

### 2. AI Service (`src/services/ai_service.py`)

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- **–£–±—Ä–∞–ª fallback-—Å–æ–æ–±—â–µ–Ω–∏—è** - –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö AI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫** - –≤—Å–µ –æ—à–∏–±–∫–∏ AI –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º—É Errors
- **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏** - —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç AI –¥–æ 3 —Ä–∞–∑

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

#### `generate_response()`
```python
# –ë—ã–ª–æ: –≤–æ–∑–≤—Ä–∞—Ç fallback –ø—Ä–∏ –ø—É—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–µ
if not ai_text and not ai_command:
    fallback_text = get_fallback_text(user_lang)
    return fallback_text, fallback_text, fallback_text, None

# –°—Ç–∞–ª–æ: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
if not ai_text and not ai_command:
    await self._log_ai_error(...)
    return "", "", "", None  # –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
```python
# –ë—ã–ª–æ: –≤–æ–∑–≤—Ä–∞—Ç fallback –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–µ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
if ai_command and (not ai_text or ai_text.strip() == ""):
    # –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏...
    return fallback_text, fallback_text, fallback_text, None

# –°—Ç–∞–ª–æ: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
if ai_command and (not ai_text or ai_text.strip() == ""):
    await self._log_ai_error(...)
    return "", "", "", None  # –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ù–ï –ø–æ–ª—É—á–∞—é—Ç fallback-—Å–æ–æ–±—â–µ–Ω–∏—è** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö AI
2. **–í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è** –≤ —Å–∏—Å—Ç–µ–º—É Errors –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
3. **–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å** –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö AI
4. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏** –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ AI

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- **–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—à–∏–±–æ–∫:** https://auraflora-bot-75152239022.asia-southeast1.run.app/errors
- **–í—Å–µ –æ—à–∏–±–∫–∏ AI** —Ç–µ–ø–µ—Ä—å –≤–∏–¥–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** –æ –ø—Ä–∏—á–∏–Ω–∞—Ö –æ—à–∏–±–æ–∫

### üîÑ –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:
1. **–ü—Ä–∏ –æ—à–∏–±–∫–µ AI** ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Errors, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. **–ü—Ä–∏ –æ—à–∏–±–∫–µ –∫–æ–º–∞–Ω–¥—ã** ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Errors, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ  
3. **–ü—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π –æ—à–∏–±–∫–µ** ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Errors, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
4. **–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–≤–µ—Ç–µ** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç AI

## üöÄ Deploy

**Deploy ID:** 20250707-235612  
**Service URL:** https://auraflora-bot-75152239022.asia-southeast1.run.app  
**Revision:** auraflora-bot-00233-m4m

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - —Å–ª–µ–¥–∏—Ç—å –∑–∞ –æ—à–∏–±–∫–∞–º–∏ –≤ —Å–∏—Å—Ç–µ–º–µ Errors
2. **–ê–Ω–∞–ª–∏–∑** - –∏–∑—É—á–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–æ–∫ AI
3. **–£–ª—É—á—à–µ–Ω–∏–µ** - –¥–æ—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –∏ –ª–æ–≥–∏–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ AI 