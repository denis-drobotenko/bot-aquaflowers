# –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–æ–∫–µ–Ω–æ–≤ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–∞

**–§–∞–π–ª:** `src/services/prompts/ai_system_prompt_structured.txt`

- **–°—Ç—Ä–æ–∫:** 266
- **–°–ª–æ–≤:** 1,390
- **–°–∏–º–≤–æ–ª–æ–≤:** 11,740
- **–†–∞–∑–º–µ—Ä:** ~11.7 KB

## üî¢ –†–∞—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤

### –ú–µ—Ç–æ–¥ 1: –ü–æ —Å–ª–æ–≤–∞–º (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
```
1,390 —Å–ª–æ–≤ √ó 1.3 —Ç–æ–∫–µ–Ω–∞/—Å–ª–æ–≤–æ = ~1,807 —Ç–æ–∫–µ–Ω–æ–≤
```

### –ú–µ—Ç–æ–¥ 2: –ü–æ —Å–∏–º–≤–æ–ª–∞–º (–±–æ–ª–µ–µ —Ç–æ—á–Ω–æ)
```
11,740 —Å–∏–º–≤–æ–ª–æ–≤ √∑ 4 —Å–∏–º–≤–æ–ª–∞/—Ç–æ–∫–µ–Ω = ~2,935 —Ç–æ–∫–µ–Ω–æ–≤
```

### –ú–µ—Ç–æ–¥ 3: –ü–æ —Å—Ç—Ä–æ–∫–∞–º –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
```
266 —Å—Ç—Ä–æ–∫ √ó 10 —Ç–æ–∫–µ–Ω–æ–≤/—Å—Ç—Ä–æ–∫–∞ = ~2,660 —Ç–æ–∫–µ–Ω–æ–≤
```

## üéØ –†–µ–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞

**–ù–∞—à —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å–∂–∏—Ä–∞–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ:**
- **2,500-3,000 —Ç–æ–∫–µ–Ω–æ–≤** (–±–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞)

## üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

### –î–ª—è Gemini 2.0 Flash (128,000 —Ç–æ–∫–µ–Ω–æ–≤):

```
–î–æ—Å—Ç—É–ø–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: 128,000 —Ç–æ–∫–µ–Ω–æ–≤
- –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: ~2,750 —Ç–æ–∫–µ–Ω–æ–≤ (2.1%)
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø–∞—Å (20%): 25,600 —Ç–æ–∫–µ–Ω–æ–≤ (20%)
= –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏: ~99,650 —Ç–æ–∫–µ–Ω–æ–≤ (77.9%)
```

### –î–ª—è Gemini 2.5 Flash (1,000,000 —Ç–æ–∫–µ–Ω–æ–≤):

```
–î–æ—Å—Ç—É–ø–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: 1,000,000 —Ç–æ–∫–µ–Ω–æ–≤
- –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: ~2,750 —Ç–æ–∫–µ–Ω–æ–≤ (0.3%)
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø–∞—Å (20%): 200,000 —Ç–æ–∫–µ–Ω–æ–≤ (20%)
= –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏: ~797,250 —Ç–æ–∫–µ–Ω–æ–≤ (79.7%)
```

## üö® –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã—Ö–æ–¥–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏

### –¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã:
- **max_output_tokens=8192** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π –ª–∏–º–∏—Ç
- **–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:** ~2,750 —Ç–æ–∫–µ–Ω–æ–≤
- **–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:** 50-100 —Å–æ–æ–±—â–µ–Ω–∏–π (~3,750-7,500 —Ç–æ–∫–µ–Ω–æ–≤)

### –†–∞—Å—á–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```
–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: 2,750 —Ç–æ–∫–µ–Ω–æ–≤
–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞: 7,500 —Ç–æ–∫–µ–Ω–æ–≤ (–º–∞–∫—Å–∏–º—É–º)
–ò—Ç–æ–≥–æ –≤—Ö–æ–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤: ~10,250 —Ç–æ–∫–µ–Ω–æ–≤

–í—ã—Ö–æ–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤: 8,192 —Ç–æ–∫–µ–Ω–æ–≤
```

## üìà –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### 1. –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞

**–ú–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –Ω–∞ 30-40%:**
- –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø—Ä–∏–º–µ—Ä—ã
- –°–æ–∫—Ä–∞—Ç–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥
- –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ø–æ—Ö–æ–∂–∏–µ —Ä–∞–∑–¥–µ–ª—ã

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è:** 800-1,200 —Ç–æ–∫–µ–Ω–æ–≤

### 2. –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞

**–ü—Ä–∏ —Ç–µ–∫—É—â–∏—Ö –ª–∏–º–∏—Ç–∞—Ö:**
- –î–æ—Å—Ç—É–ø–Ω–æ: ~99,650 —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: ~7,500 —Ç–æ–∫–µ–Ω–æ–≤
- **–ü–æ—Ç–µ—Ä—è:** ~92,000 —Ç–æ–∫–µ–Ω–æ–≤!

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤ 10-15 —Ä–∞–∑

### 3. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

```python
def calculate_optimal_limits():
    system_prompt_tokens = 2750
    max_context = 128000
    safety_margin = max_context * 0.2
    
    available_for_history = max_context - system_prompt_tokens - safety_margin
    tokens_per_message = 75  # —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
    
    optimal_history_limit = int(available_for_history / tokens_per_message)
    return optimal_history_limit  # ~1,300 —Å–æ–æ–±—â–µ–Ω–∏–π!
```

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å–∂–∏—Ä–∞–µ—Ç –≤—Å–µ–≥–æ 2.1% –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –æ–∫–Ω–∞!**

–ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ –ø—Ä–æ–º–ø—Ç–µ, –∞ –≤ —Ç–æ–º, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ 7.5% –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –û—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –µ—Å—Ç—å (–æ–Ω –æ–ø—Ç–∏–º–∞–ª–µ–Ω)
2. –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Å 50-100 –¥–æ 500-1000 —Å–æ–æ–±—â–µ–Ω–∏–π
3. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ª–∏–º–∏—Ç—ã 