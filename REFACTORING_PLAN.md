# ПЛАН РЕФАКТОРИНГА АРХИТЕКТУРЫ ОБРАБОТКИ СООБЩЕНИЙ

## АНАЛИЗ ТЕКУЩИХ ПРОБЛЕМ

### Проблемы архитектуры:
- [ ] Дублирование ответственности между `MessageHandler` и `MessageProcessor`
- [ ] Сложный flow данных: `Webhook → WebhookHandler → MessageProcessor → MessageHandler → AI → MessageProcessor → WhatsApp`
- [ ] Путаница с обработкой типов сообщений (интерактивные, reply-контекст)
- [ ] Неэффективное использование сервисов (создание в методах)
- [ ] Разные места сохранения сообщений в БД

### Текущий flow:
```
Webhook → WebhookHandler (валидация) → MessageProcessor (создает MessageHandler) → MessageHandler (AI логика) → MessageProcessor (отправка)
```

## ЦЕЛЬ РЕФАКТОРИНГА

### Новый flow:
```
Webhook → WebhookHandler (извлечение + предобработка) → MessageProcessor (бизнес-логика)
```

### Принципы:
- [ ] Четкое разделение ответственности
- [ ] Линейный flow данных
- [ ] Единая точка сохранения сообщений
- [ ] Простое тестирование
- [ ] Легкое добавление новых типов сообщений

## ЭТАП 1: РЕОРГАНИЗАЦИЯ WEBHOOKHANDLER

### Цель: Сделать WebhookHandler единой точкой извлечения и предобработки данных

#### 1.1 Расширить метод extract_and_process_message()
- [x] Добавить обработку разных типов сообщений (text, interactive, image, etc.)
- [x] Добавить обработку reply-контекста
- [x] Добавить обработку интерактивных сообщений (кнопки, списки)
- [x] Возвращать готовый объект с данными сообщения

#### 1.2 Добавить методы обработки интерактивных сообщений
- [x] `process_interactive_message()` - обработка button_reply, list_reply
- [x] `extract_button_text()` - извлечение текста кнопки
- [x] `extract_list_text()` - извлечение текста из списка

#### 1.3 Добавить обработку reply-контекста
- [x] `enhance_with_reply_context()` - добавление контекста к сообщению
- [x] `get_reply_context()` - получение контекста из БД
- [x] Интеграция с MessageService для поиска сообщений

#### 1.4 Обновить process_webhook()
- [x] Упростить логику ветвления
- [x] Отсекать технические статусы сразу
- [x] Передавать готовые данные в MessageProcessor

## ЭТАП 2: УПРОЩЕНИЕ MESSAGEPROCESSOR

### Цель: Сделать MessageProcessor единой точкой бизнес-логики

#### 2.1 Удалить дублирование с MessageHandler
- [x] Убрать создание MessageHandler в `process_message()`
- [x] Перенести всю логику AI обработки в MessageProcessor
- [x] Убрать дублирующие методы

#### 2.2 Создать единый метод обработки
- [x] `process_user_message()` - главный метод обработки
- [x] Разбить на логические этапы:
  - [x] Управление сессиями
  - [x] Проверка специальных команд
  - [x] Сохранение сообщений пользователя
  - [x] AI обработка
  - [x] Обработка команд AI
  - [x] Отправка ответов

#### 2.3 Добавить методы для каждого этапа
- [x] `handle_newses_command()` - обработка команды /newses
- [x] `save_user_message()` - сохранение сообщения пользователя
- [x] `process_with_ai()` - AI обработка с переводами
- [x] `handle_ai_command()` - обработка команд от AI
- [x] `send_ai_response()` - отправка ответа пользователю

#### 2.4 Оптимизировать инициализацию сервисов
- [x] Инициализировать все сервисы в конструкторе
- [x] Убрать создание сервисов в методах
- [x] Добавить в конструктор:
  - [x] SessionService
  - [x] UserService
  - [x] AIService
  - [x] CommandService

## ЭТАП 3: УДАЛЕНИЕ MESSAGEHANDLER

### Цель: Убрать дублирующий класс

#### 3.1 Перенести полезные методы
- [x] `_handle_newses_command()` → `MessageProcessor.handle_newses_command()`
- [x] `_enhance_message_with_reply_context()` → `WebhookHandler.enhance_with_reply_context()`
- [x] Логику определения языка → `MessageProcessor.process_with_ai()`
- [x] Логику переводов → `MessageProcessor.process_with_ai()`

#### 3.2 Обновить импорты
- [x] Найти все импорты MessageHandler
- [x] Заменить на MessageProcessor
- [x] Обновить вызовы методов

#### 3.3 Удалить файл
- [x] Удалить `src/handlers/message_handler.py`
- [x] Проверить, что нет неиспользуемых импортов

## ЭТАП 4: ОПТИМИЗАЦИЯ СЕРВИСОВ

### Цель: Убрать создание сервисов в методах

#### 4.1 Обновить конструктор MessageProcessor
```python
def __init__(self):
    self.whatsapp_client = WhatsAppClient()
    self.message_service = MessageService()
    self.session_service = SessionService()
    self.user_service = UserService()
    self.ai_service = AIService(GEMINI_API_KEY)
    self.command_service = CommandService()
```

#### 4.2 Убрать создание сервисов в методах
- [x] Удалить `SessionService()` из `process_message()`
- [x] Удалить `UserService()` из `process_message()`
- [x] Удалить `CommandService()` из `process_message()`
- [x] Использовать self.session_service, self.user_service, self.command_service

## ЭТАП 5: УПРОЩЕНИЕ FLOW

### Цель: Сделать flow линейным и понятным

#### 5.1 Обновить WebhookHandler
- [x] Упростить `process_webhook()`
- [x] Сделать четкое ветвление: статусы vs сообщения
- [x] Передавать готовые данные в MessageProcessor

#### 5.2 Обновить MessageProcessor
- [x] Создать единый метод `process_user_message()`
- [x] Разбить на логические этапы
- [x] Убрать дублирование логики

#### 5.3 Обновить app.py
- [x] Проверить, что webhook роуты работают корректно
- [x] Убедиться, что все импорты актуальны

## ЭТАП 6: ТЕСТИРОВАНИЕ

### Цель: Убедиться, что рефакторинг не сломал функциональность

#### 6.1 Тестирование WebhookHandler
- [ ] Тест валидации webhook
- [ ] Тест обработки статусов
- [ ] Тест извлечения текстовых сообщений
- [ ] Тест обработки интерактивных сообщений
- [ ] Тест добавления reply-контекста

#### 6.2 Тестирование MessageProcessor
- [ ] Тест обработки обычных сообщений
- [ ] Тест обработки команды /newses
- [ ] Тест AI обработки
- [ ] Тест обработки команд AI
- [ ] Тест отправки ответов

#### 6.3 Интеграционное тестирование
- [ ] Тест полного flow от webhook до ответа
- [ ] Тест обработки разных типов сообщений
- [ ] Тест работы с сессиями
- [ ] Тест сохранения в БД

## ЭТАП 7: ДОКУМЕНТАЦИЯ

### Цель: Обновить документацию архитектуры

#### 7.1 Обновить README
- [ ] Описать новую архитектуру
- [ ] Объяснить flow обработки сообщений
- [ ] Добавить диаграмму архитектуры

#### 7.2 Обновить комментарии в коде
- [ ] Добавить docstrings к новым методам
- [ ] Обновить комментарии к измененным методам
- [ ] Удалить устаревшие комментарии

## ПРОВЕРКА РЕЗУЛЬТАТА

### Критерии успеха:
- [ ] Убран MessageHandler
- [ ] WebhookHandler отвечает только за извлечение и предобработку
- [ ] MessageProcessor отвечает только за бизнес-логику
- [ ] Flow стал линейным: Webhook → WebhookHandler → MessageProcessor
- [ ] Нет дублирования логики
- [ ] Все тесты проходят
- [ ] Функциональность не сломана

### Метрики улучшения:
- [ ] Уменьшение количества файлов
- [ ] Упрощение flow (меньше переходов между классами)
- [ ] Улучшение читаемости кода
- [ ] Ускорение разработки новых функций

## ПРИМЕЧАНИЯ

- Рефакторинг выполнять поэтапно
- После каждого этапа тестировать функциональность
- При возникновении проблем - откатываться к предыдущему этапу
- Документировать все изменения
- Обновлять тесты параллельно с изменениями 