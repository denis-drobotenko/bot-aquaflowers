#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ AI
"""

import asyncio
import sys
import os
import pytest

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É –¥–ª—è Windows
if sys.stdout.encoding.lower() != 'utf-8':
    sys.stdout.reconfigure(encoding='utf-8')

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å
current_dir = os.path.dirname(__file__)
src_path = os.path.join(current_dir, '..', 'src')
sys.path.insert(0, src_path)

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å
project_root = os.path.join(current_dir, '..')
sys.path.insert(0, project_root)

try:
    from src.ai_manager import get_ai_response
    from src.command_handler import handle_commands
except ImportError:
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–º–ø–æ—Ä—Ç–∞
    import src.ai_manager as ai_manager
    import src.command_handler as command_handler
    
    def get_ai_response(session_id, history):
        return ai_manager.get_ai_response(session_id, history)
    
    def handle_commands(session_id, text):
        return command_handler.handle_commands(session_id, text)

@pytest.mark.asyncio
async def test_active_dialog():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ AI"""
    print("=== –¢–ï–°–¢ –ê–ö–¢–ò–í–ù–û–ì–û –î–ò–ê–õ–û–ì–ê ===")
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π session_id –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    session_id = "test_active_dialog_session"
    
    # –¢–µ—Å—Ç 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    print("\n1. –¢–µ—Å—Ç: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ")
    history = [
        {'role': 'user', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç'}]}
    ]
    
    ai_text, ai_commands = get_ai_response(session_id, history)
    print(f"AI –æ—Ç–≤–µ—Ç: {ai_text}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–∞—Ç–∞–ª–æ–≥
    if "?" in ai_text and ("–∫–∞—Ç–∞–ª–æ–≥" in ai_text.lower() or "—Ö–æ—Ç–∏—Ç–µ" in ai_text.lower()):
        print("‚úÖ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–∞—Ç–∞–ª–æ–≥!")
    else:
        print("‚ùå AI –Ω–µ –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–∞—Ç–∞–ª–æ–≥")
    
    # –¢–µ—Å—Ç 2: –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥
    print("\n2. –¢–µ—Å—Ç: –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥")
    history = [
        {'role': 'user', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç'}]},
        {'role': 'assistant', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AURAFLORA! üå∏ –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, –ø–æ–∫–∞–∂–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥'}]}
    ]
    
    ai_text, ai_commands = get_ai_response(session_id, history)
    print(f"AI –æ—Ç–≤–µ—Ç: {ai_text}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ AI –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–∞—Ç–∞–ª–æ–≥ –∏ —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ –≤—ã–±–æ—Ä –±—É–∫–µ—Ç–∞
    if "–∫–∞—Ç–∞–ª–æ–≥" in ai_text.lower() and "?" in ai_text and ("–∫–∞–∫–æ–π" in ai_text.lower() or "–±—É–∫–µ—Ç" in ai_text.lower()):
        print("‚úÖ AI –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–∞—Ç–∞–ª–æ–≥ –∏ —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ –≤—ã–±–æ—Ä –±—É–∫–µ—Ç–∞!")
    else:
        print("‚ùå AI –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–∞—Ç–∞–ª–æ–≥ –∏–ª–∏ –Ω–µ —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ –≤—ã–±–æ—Ä –±—É–∫–µ—Ç–∞")
    
    # –¢–µ—Å—Ç 3: –í—ã–±–æ—Ä –±—É–∫–µ—Ç–∞
    print("\n3. –¢–µ—Å—Ç: –í—ã–±–æ—Ä –±—É–∫–µ—Ç–∞")
    history = [
        {'role': 'user', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç'}]},
        {'role': 'assistant', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AURAFLORA! üå∏ –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, –ø–æ–∫–∞–∂–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤! –ö–∞–∫–æ–π –±—É–∫–µ—Ç –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è?'}]},
        {'role': 'user', 'parts': [{'text': 'Spirit üå∏'}]}  # –ù–∞–∑–≤–∞–Ω–∏–µ –±—É–∫–µ—Ç–∞
    ]
    
    ai_text, ai_commands = get_ai_response(session_id, history)
    print(f"AI –æ—Ç–≤–µ—Ç: {ai_text}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–∞—Ç—É/–≤—Ä–µ–º—è
    if "?" in ai_text and ("–∫–æ–≥–¥–∞" in ai_text.lower() or "–¥–∞—Ç–∞" in ai_text.lower() or "–≤—Ä–µ–º—è" in ai_text.lower()):
        print("‚úÖ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–∞—Ç—É/–≤—Ä–µ–º—è!")
    else:
        print("‚ùå AI –Ω–µ –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–∞—Ç—É/–≤—Ä–µ–º—è")
    
    # –¢–µ—Å—Ç 4: –£–∫–∞–∑–∞–Ω–∏–µ –¥–∞—Ç—ã
    print("\n4. –¢–µ—Å—Ç: –£–∫–∞–∑–∞–Ω–∏–µ –¥–∞—Ç—ã")
    history = [
        {'role': 'user', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç'}]},
        {'role': 'assistant', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AURAFLORA! üå∏ –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, –ø–æ–∫–∞–∂–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤! –ö–∞–∫–æ–π –±—É–∫–µ—Ç –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è?'}]},
        {'role': 'user', 'parts': [{'text': 'Spirit üå∏'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞–ª –≤–∞—à –≤—ã–±–æ—Ä –±—É–∫–µ—Ç–∞ \'Spirit üå∏\'. –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞? (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)'}]},
        {'role': 'user', 'parts': [{'text': '15 –¥–µ–∫–∞–±—Ä—è –≤ 14:00'}]}
    ]
    
    ai_text, ai_commands = get_ai_response(session_id, history)
    print(f"AI –æ—Ç–≤–µ—Ç: {ai_text}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É
    if "?" in ai_text and ("–¥–æ—Å—Ç–∞–≤–∫–∞" in ai_text.lower() or "–∫—É–¥–∞" in ai_text.lower() or "–∞–¥—Ä–µ—Å" in ai_text.lower()):
        print("‚úÖ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É!")
    else:
        print("‚ùå AI –Ω–µ –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É")
    
    # –¢–µ—Å—Ç 5: –û—Ç–≤–µ—Ç –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É
    print("\n5. –¢–µ—Å—Ç: –û—Ç–≤–µ—Ç –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É")
    history = [
        {'role': 'user', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç'}]},
        {'role': 'assistant', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AURAFLORA! üå∏ –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, –ø–æ–∫–∞–∂–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤! –ö–∞–∫–æ–π –±—É–∫–µ—Ç –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è?'}]},
        {'role': 'user', 'parts': [{'text': 'Spirit üå∏'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞–ª –≤–∞—à –≤—ã–±–æ—Ä –±—É–∫–µ—Ç–∞ \'Spirit üå∏\'. –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞? (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)'}]},
        {'role': 'user', 'parts': [{'text': '15 –¥–µ–∫–∞–±—Ä—è –≤ 14:00'}]},
        {'role': 'assistant', 'parts': [{'text': '–ó–∞–ø–∏—Å–∞–ª –¥–∞—Ç—É –¥–æ—Å—Ç–∞–≤–∫–∏: 15 –¥–µ–∫–∞–±—Ä—è –≤ 14:00. –ù—É–∂–Ω–∞ –ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞? –ï—Å–ª–∏ –¥–∞, —Ç–æ –∫—É–¥–∞?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, —É–ª. –ü—É—à–∫–∏–Ω–∞, 10'}]}
    ]
    
    ai_text, ai_commands = get_ai_response(session_id, history)
    print(f"AI –æ—Ç–≤–µ—Ç: {ai_text}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –æ—Ç–∫—Ä—ã—Ç–∫—É
    if "?" in ai_text and ("–æ—Ç–∫—Ä—ã—Ç–∫–∞" in ai_text.lower() or "—Ç–µ–∫—Å—Ç" in ai_text.lower()):
        print("‚úÖ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –æ—Ç–∫—Ä—ã—Ç–∫—É!")
    else:
        print("‚ùå AI –Ω–µ –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –æ—Ç–∫—Ä—ã—Ç–∫—É")
    
    # –¢–µ—Å—Ç 6: –û—Ç–≤–µ—Ç –ø—Ä–æ –æ—Ç–∫—Ä—ã—Ç–∫—É
    print("\n6. –¢–µ—Å—Ç: –û—Ç–≤–µ—Ç –ø—Ä–æ –æ—Ç–∫—Ä—ã—Ç–∫—É")
    history = [
        {'role': 'user', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç'}]},
        {'role': 'assistant', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AURAFLORA! üå∏ –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, –ø–æ–∫–∞–∂–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤! –ö–∞–∫–æ–π –±—É–∫–µ—Ç –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è?'}]},
        {'role': 'user', 'parts': [{'text': 'Spirit üå∏'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞–ª –≤–∞—à –≤—ã–±–æ—Ä –±—É–∫–µ—Ç–∞ \'Spirit üå∏\'. –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞? (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)'}]},
        {'role': 'user', 'parts': [{'text': '15 –¥–µ–∫–∞–±—Ä—è –≤ 14:00'}]},
        {'role': 'assistant', 'parts': [{'text': '–ó–∞–ø–∏—Å–∞–ª –¥–∞—Ç—É –¥–æ—Å—Ç–∞–≤–∫–∏: 15 –¥–µ–∫–∞–±—Ä—è –≤ 14:00. –ù—É–∂–Ω–∞ –ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞? –ï—Å–ª–∏ –¥–∞, —Ç–æ –∫—É–¥–∞?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, —É–ª. –ü—É—à–∫–∏–Ω–∞, 10'}]},
        {'role': 'assistant', 'parts': [{'text': '–ü–æ–Ω—è–ª! –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –∞–¥—Ä–µ—Å—É: —É–ª. –ü—É—à–∫–∏–Ω–∞, 10. –ù—É–∂–Ω–∞ –ª–∏ –æ—Ç–∫—Ä—ã—Ç–∫–∞ –∫ –±—É–∫–µ—Ç—É? –ï—Å–ª–∏ –¥–∞, —Ç–æ –∫–∞–∫–æ–π —Ç–µ–∫—Å—Ç?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, –° –ª—é–±–æ–≤—å—é!'}]}
    ]
    
    ai_text, ai_commands = get_ai_response(session_id, history)
    print(f"AI –æ—Ç–≤–µ—Ç: {ai_text}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
    if "?" in ai_text and ("–ø–æ–ª—É—á–∞—Ç–µ–ª—è" in ai_text.lower() or "–∑–æ–≤—É—Ç" in ai_text.lower()):
        print("‚úÖ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è!")
    else:
        print("‚ùå AI –Ω–µ –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è")
    
    # –¢–µ—Å—Ç 7: –ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
    print("\n7. –¢–µ—Å—Ç: –ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è")
    history = [
        {'role': 'user', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç'}]},
        {'role': 'assistant', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AURAFLORA! üå∏ –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, –ø–æ–∫–∞–∂–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤! –ö–∞–∫–æ–π –±—É–∫–µ—Ç –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è?'}]},
        {'role': 'user', 'parts': [{'text': 'Spirit üå∏'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞–ª –≤–∞—à –≤—ã–±–æ—Ä –±—É–∫–µ—Ç–∞ \'Spirit üå∏\'. –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞? (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)'}]},
        {'role': 'user', 'parts': [{'text': '15 –¥–µ–∫–∞–±—Ä—è –≤ 14:00'}]},
        {'role': 'assistant', 'parts': [{'text': '–ó–∞–ø–∏—Å–∞–ª –¥–∞—Ç—É –¥–æ—Å—Ç–∞–≤–∫–∏: 15 –¥–µ–∫–∞–±—Ä—è –≤ 14:00. –ù—É–∂–Ω–∞ –ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞? –ï—Å–ª–∏ –¥–∞, —Ç–æ –∫—É–¥–∞?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, —É–ª. –ü—É—à–∫–∏–Ω–∞, 10'}]},
        {'role': 'assistant', 'parts': [{'text': '–ü–æ–Ω—è–ª! –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –∞–¥—Ä–µ—Å—É: —É–ª. –ü—É—à–∫–∏–Ω–∞, 10. –ù—É–∂–Ω–∞ –ª–∏ –æ—Ç–∫—Ä—ã—Ç–∫–∞ –∫ –±—É–∫–µ—Ç—É? –ï—Å–ª–∏ –¥–∞, —Ç–æ –∫–∞–∫–æ–π —Ç–µ–∫—Å—Ç?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, –° –ª—é–±–æ–≤—å—é!'}]},
        {'role': 'assistant', 'parts': [{'text': '–ó–∞–ø–∏—Å–∞–ª —Ç–µ–∫—Å—Ç –æ—Ç–∫—Ä—ã—Ç–∫–∏: \'–° –ª—é–±–æ–≤—å—é!\'. –ö–∞–∫ –∑–æ–≤—É—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è –±—É–∫–µ—Ç–∞?'}]},
        {'role': 'user', 'parts': [{'text': '–ê–Ω–Ω–∞'}]}
    ]
    
    ai_text, ai_commands = get_ai_response(session_id, history)
    print(f"AI –æ—Ç–≤–µ—Ç: {ai_text}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è
    if "?" in ai_text and ("—Ç–µ–ª–µ—Ñ–æ–Ω" in ai_text.lower() or "–Ω–æ–º–µ—Ä" in ai_text.lower()):
        print("‚úÖ AI –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è!")
    else:
        print("‚ùå AI –Ω–µ –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è")
    
    # –¢–µ—Å—Ç 8: –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ —Å–≤–æ–¥–∫–∞ –∑–∞–∫–∞–∑–∞
    print("\n8. –¢–µ—Å—Ç: –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ —Å–≤–æ–¥–∫–∞ –∑–∞–∫–∞–∑–∞")
    history = [
        {'role': 'user', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç'}]},
        {'role': 'assistant', 'parts': [{'text': '–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AURAFLORA! üå∏ –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, –ø–æ–∫–∞–∂–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤! –ö–∞–∫–æ–π –±—É–∫–µ—Ç –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è?'}]},
        {'role': 'user', 'parts': [{'text': 'Spirit üå∏'}]},
        {'role': 'assistant', 'parts': [{'text': '–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞–ª –≤–∞—à –≤—ã–±–æ—Ä –±—É–∫–µ—Ç–∞ \'Spirit üå∏\'. –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞? (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)'}]},
        {'role': 'user', 'parts': [{'text': '15 –¥–µ–∫–∞–±—Ä—è –≤ 14:00'}]},
        {'role': 'assistant', 'parts': [{'text': '–ó–∞–ø–∏—Å–∞–ª –¥–∞—Ç—É –¥–æ—Å—Ç–∞–≤–∫–∏: 15 –¥–µ–∫–∞–±—Ä—è –≤ 14:00. –ù—É–∂–Ω–∞ –ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞? –ï—Å–ª–∏ –¥–∞, —Ç–æ –∫—É–¥–∞?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, —É–ª. –ü—É—à–∫–∏–Ω–∞, 10'}]},
        {'role': 'assistant', 'parts': [{'text': '–ü–æ–Ω—è–ª! –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –∞–¥—Ä–µ—Å—É: —É–ª. –ü—É—à–∫–∏–Ω–∞, 10. –ù—É–∂–Ω–∞ –ª–∏ –æ—Ç–∫—Ä—ã—Ç–∫–∞ –∫ –±—É–∫–µ—Ç—É? –ï—Å–ª–∏ –¥–∞, —Ç–æ –∫–∞–∫–æ–π —Ç–µ–∫—Å—Ç?'}]},
        {'role': 'user', 'parts': [{'text': '–î–∞, –° –ª—é–±–æ–≤—å—é!'}]},
        {'role': 'assistant', 'parts': [{'text': '–ó–∞–ø–∏—Å–∞–ª —Ç–µ–∫—Å—Ç –æ—Ç–∫—Ä—ã—Ç–∫–∏: \'–° –ª—é–±–æ–≤—å—é!\'. –ö–∞–∫ –∑–æ–≤—É—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è –±—É–∫–µ—Ç–∞?'}]},
        {'role': 'user', 'parts': [{'text': '–ê–Ω–Ω–∞'}]},
        {'role': 'assistant', 'parts': [{'text': '–ó–∞–ø–∏—Å–∞–ª –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è: –ê–Ω–Ω–∞. –ö–∞–∫–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è?'}]},
        {'role': 'user', 'parts': [{'text': '+7 999 123-45-67'}]}
    ]
    
    ai_text, ai_commands = get_ai_response(session_id, history)
    print(f"AI –æ—Ç–≤–µ—Ç: {ai_text}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ AI –ø–æ–∫–∞–∑–∞–ª —Å–≤–æ–¥–∫—É –∑–∞–∫–∞–∑–∞ –∏ —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if "—Å–≤–æ–¥–∫–∞" in ai_text.lower() and "?" in ai_text and ("–≤–µ—Ä–Ω–æ" in ai_text.lower() or "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ" in ai_text.lower()):
        print("‚úÖ AI –ø–æ–∫–∞–∑–∞–ª —Å–≤–æ–¥–∫—É –∑–∞–∫–∞–∑–∞ –∏ —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ!")
    else:
        print("‚ùå AI –Ω–µ –ø–æ–∫–∞–∑–∞–ª —Å–≤–æ–¥–∫—É –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –Ω–µ —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ")
    
    # –¢–µ—Å—Ç 9: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ LINE
    print("\n9. –¢–µ—Å—Ç: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ LINE")
    order_data = {
        'type': 'confirm_order',
        'bouquet': 'Spirit üå∏',
        'date': '15 –¥–µ–∫–∞–±—Ä—è',
        'time': '14:00',
        'delivery_needed': 'True',
        'address': '—É–ª. –ü—É—à–∫–∏–Ω–∞, 10',
        'card_needed': 'True',
        'card_text': '–° –ª—é–±–æ–≤—å—é!',
        'recipient_name': '–ê–Ω–Ω–∞',
        'recipient_phone': '+7 999 123-45-67',
        'retailer_id': 'test_bouquet_id'
    }
    result = await handle_commands(session_id, session_id, order_data)
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞: {result}")
    print("‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ –≤ LINE –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    
    print("\n=== –¢–ï–°–¢ –ê–ö–¢–ò–í–ù–û–ì–û –î–ò–ê–õ–û–ì–ê –ó–ê–í–ï–†–®–ï–ù ===")
    print("‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –ø—Ä–æ–π–¥–µ–Ω—ã!")

if __name__ == "__main__":
    asyncio.run(test_active_dialog()) 