#!/usr/bin/env python3
"""
–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –≤ WhatsApp —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.whatsapp_utils import send_whatsapp_message
import asyncio

def test_whatsapp_formatting():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –≤ WhatsApp —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"""
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –≤ WhatsApp —Å–æ–æ–±—â–µ–Ω–∏—è—Ö")
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫
    test_messages = [
        {
            "name": "–ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏",
            "text": "–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞\n–í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞"
        },
        {
            "name": "–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã",
            "text": "–°—Ç—Ä–æ–∫–∞ 1\n\n–°—Ç—Ä–æ–∫–∞ 2\n\n–°—Ç—Ä–æ–∫–∞ 3"
        },
        {
            "name": "–°–ø–∏—Å–∫–∏ —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏",
            "text": "–ù–∞—à –ø—Ä–∞–π—Å-–ª–∏—Å—Ç:\n* –†–∞–≤–∞–∏: 500 –±–∞—Ç\n* –ß–∞–ª–æ–Ω–≥: 380 –±–∞—Ç\n* –ü—Ö—É–∫–µ—Ç-–¢–∞—É–Ω: 300 –±–∞—Ç"
        },
        {
            "name": "–°–º–µ—à–∞–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
            "text": "üå∏ –ü—Ä–∏–≤–µ—Ç!\n\n–ö–∞–∫ –¥–µ–ª–∞?\n\n–ù–∞–¥–µ—é—Å—å, –≤—Å–µ —Ö–æ—Ä–æ—à–æ! üå∏"
        }
    ]
    
    for test_case in test_messages:
        print(f"\nüìù –¢–µ—Å—Ç: {test_case['name']}")
        print(f"   –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:")
        print(f"   '{test_case['text']}'")
        
        # –ò–º–∏—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —á–µ—Ä–µ–∑ clean_message
        import re
        def clean_message(text):
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è WhatsApp, –Ω–æ —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
            # –ó–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –æ–¥–∏–Ω, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º \n
            # –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
            text = re.sub(r'[ \t]+', ' ', text)
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫
            text = re.sub(r'^[ \t]+', '', text, flags=re.MULTILINE)
            text = re.sub(r'[ \t]+$', '', text, flags=re.MULTILINE)
            # –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
            text = text.strip()
            return text
        
        cleaned_text = clean_message(test_case['text'])
        print(f"   –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:")
        print(f"   '{cleaned_text}'")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å
        if '\n' in cleaned_text:
            print(f"   ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
        else:
            print(f"   ‚ùå –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –ø–æ—Ç–µ—Ä—è–Ω—ã")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
        original_lines = test_case['text'].split('\n')
        cleaned_lines = cleaned_text.split('\n')
        
        if len(original_lines) == len(cleaned_lines):
            print(f"   ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {len(original_lines)}")
        else:
            print(f"   ‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å: –±—ã–ª–æ {len(original_lines)}, —Å—Ç–∞–ª–æ {len(cleaned_lines)}")

def test_whatsapp_message_structure():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É WhatsApp —Å–æ–æ–±—â–µ–Ω–∏—è"""
    
    print("\nüîß –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É WhatsApp —Å–æ–æ–±—â–µ–Ω–∏—è")
    
    # –ò–º–∏—Ç–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—É—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WhatsApp API
    test_message = "–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞\n\n–í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞\n\n–¢—Ä–µ—Ç—å—è —Å—Ç—Ä–æ–∫–∞"
    
    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ payload –¥–ª—è WhatsApp API
    payload = {
        "messaging_product": "whatsapp",
        "to": "test_number",
        "type": "text",
        "text": {
            "body": test_message
        }
    }
    
    print(f"   Payload –¥–ª—è WhatsApp API:")
    print(f"   {payload}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ body —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    body = payload["text"]["body"]
    if '\n' in body:
        print(f"   ‚úÖ Body —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫")
        print(f"   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: {len(body.split(chr(10)))}")
    else:
        print(f"   ‚ùå Body –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫")

if __name__ == "__main__":
    print("üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è WhatsApp —Å–æ–æ–±—â–µ–Ω–∏–π")
    test_whatsapp_formatting()
    test_whatsapp_message_structure()
    print("\n‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω") 
 