<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>AuraFlora Debug</title>
    <link rel="stylesheet" href="/static/css/debug.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå∏ AuraFlora Debug Interface</h1>
            <p>–û—Ç–ª–∞–¥–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –∏ AI –ø–∞–π–ø–ª–∞–π–Ω–∞</p>
        </div>
        
        <div class="grid">
            <div class="sessions">
                <h3>–°–µ—Å—Å–∏–∏</h3>
                <button onclick="loadSessions()" style="margin-bottom: 10px;">–û–±–Ω–æ–≤–∏—Ç—å</button>
                <div id="sessions-list">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <div class="dialog">
                <h3>–î–∏–∞–ª–æ–≥</h3>
                <div id="dialog-content">
                    <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSession = null;
        
        async function loadSessions() {
            try {
                const response = await fetch('/debug/api/sessions');
                const sessions = await response.json();
                
                const list = document.getElementById('sessions-list');
                
                if (sessions.length === 0) {
                    list.innerHTML = '<div>–ù–µ—Ç —Å–µ—Å—Å–∏–π</div>';
                    return;
                }
                
                list.innerHTML = sessions.map(session => `
                    <div class="session-item" onclick="selectSession('${session.session_id}')">
                        <strong>${session.sender_id}</strong><br>
                        <small>${new Date(session.last_message_time).toLocaleString()}</small><br>
                        <small>${session.message_count} —Å–æ–æ–±—â–µ–Ω–∏–π</small>
                    </div>
                `).join('');
                
            } catch (error) {
                document.getElementById('sessions-list').innerHTML = '<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }
        
        async function selectSession(sessionId) {
            document.querySelectorAll('.session-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            currentSession = sessionId;
            
            document.getElementById('dialog-content').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–∞...</div>';
            
            try {
                const response = await fetch(`/debug/api/session/${sessionId}/messages`);
                const data = await response.json();
                
                displayDialog(data.messages, data.logs);
                
            } catch (error) {
                document.getElementById('dialog-content').innerHTML = '<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–∞</div>';
            }
        }
        
        function displayDialog(messages, logs) {
            const content = document.getElementById('dialog-content');
            
            if (messages.length === 0) {
                content.innerHTML = '<div>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                return;
            }
            
            content.innerHTML = messages.map((message, index) => {
                const messageLogs = logs.filter(log => 
                    Math.abs(new Date(log.timestamp) - new Date(message.timestamp)) < 30000
                );
                
                return `
                    <div class="message ${message.role}">
                        <strong>${message.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : 'AuraFlora'}</strong>
                        <small>${new Date(message.timestamp).toLocaleTimeString()}</small>
                        <div>${escapeHtml(message.content)}</div>
                        
                        ${messageLogs.length > 0 ? `
                            <button class="debug-btn" onclick="toggleDebug(${index})">
                                –î–µ—Ç–∞–ª–∏ (${messageLogs.length})
                            </button>
                            <div class="debug-details" id="debug-${index}" style="display: none;">
                                ${formatLogs(messageLogs)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function toggleDebug(index) {
            const details = document.getElementById(`debug-${index}`);
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
        }
        
        function formatLogs(logs) {
            return logs.map(log => `
                <div class="log-entry">
                    <strong>${log.logger_name}</strong> [${log.level}]<br>
                    <small>${new Date(log.timestamp).toLocaleTimeString()}</small><br>
                    ${escapeHtml(log.message)}
                </div>
            `).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadSessions();
    </script>
</body>
</html> 