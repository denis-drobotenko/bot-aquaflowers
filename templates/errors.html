<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Management - AURAFLORA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007aff;
            --primary-gradient: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            --background-color: #f8f9fa;
            --surface-color: #fff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --border-color: #e5e5e7;
            --shadow-light: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-medium: 0 4px 16px rgba(0,0,0,0.12);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: var(--background-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }
        
        .main-errors-area {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            background: var(--surface-color);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-shadow: var(--shadow-medium);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .errors-header-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface-color);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .errors-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .errors-title i {
            color: var(--danger-color);
        }
        
        .errors-tabs {
            display: flex;
            gap: 8px;
        }
        
        .errors-tab {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 18px;
            font-size: 1em;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .errors-tab.active {
            border-color: var(--danger-color);
            background: linear-gradient(135deg, var(--danger-color) 0%, #c0392b 100%);
            color: #fff;
        }
        
        .errors-tab:hover:not(.active) {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        
        .errors-scroll-area {
            flex: 1 1 auto;
            overflow-y: auto;
            background: var(--background-color);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .errors-section {
            margin: 24px 0 0 0;
            padding: 0 20px;
        }
        
        .errors-section h2 {
            font-size: 1.2em;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-weight: 700;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--surface-color);
            border-radius: 14px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-card.critical { border-left-color: var(--danger-color); }
        .stat-card.high { border-left-color: var(--warning-color); }
        .stat-card.medium { border-left-color: var(--info-color); }
        .stat-card.low { border-left-color: var(--success-color); }
        
        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .error-card {
            background: var(--surface-color);
            border-radius: 14px;
            padding: 16px 18px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--danger-color);
            transition: var(--transition);
        }
        
        .error-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .error-card.resolved { border-left-color: var(--success-color); }
        .error-card.in-progress { border-left-color: var(--warning-color); }
        .error-card.ignored { border-left-color: var(--text-secondary); }
        
        .error-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .error-info {
            flex: 1;
        }
        
        .error-title {
            font-weight: 600;
            font-size: 1.05em;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .error-message {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin-bottom: 8px;
        }
        
        .error-meta {
            display: flex;
            gap: 16px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .error-time {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .error-module {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .error-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            background: var(--background-color);
            color: var(--danger-color);
        }
        
        .status-new { background: var(--danger-color); color: white; }
        .status-in-progress { background: var(--warning-color); color: white; }
        .status-resolved { background: var(--success-color); color: white; }
        .status-ignored { background: var(--text-secondary); color: white; }
        
        .error-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--background-color);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .btn-icon:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }
        
        .btn-icon.resolve:hover {
            background: var(--success-color);
        }
        
        .btn-icon.ignore:hover {
            background: var(--text-secondary);
        }
        
        .error-details {
            background: var(--background-color);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .error-details pre {
            margin: 8px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .filters-section {
            background: var(--surface-color);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-light);
        }
        
        .filters-row {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface-color);
            color: var(--text-primary);
            font-size: 0.9em;
            transition: var(--transition);
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            color: var(--border-color);
        }
        
        .empty-state h3 {
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .collapsible-section {
            margin-bottom: 18px;
        }
        
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 12px;
        }
        
        .collapsible-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: var(--text-primary);
            font-weight: 700;
        }
        
        .collapsible-content {
            display: none;
        }
        
        .collapsible-content.show {
            display: block;
        }
        
        .refresh-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
    </style>
</head>
<body>
    <div class="main-errors-area">
        <div class="errors-header-bar">
            <div class="errors-title">
                <i class="fas fa-exclamation-triangle"></i>
                Error Management
            </div>
            <div class="errors-tabs">
                <div class="errors-tab active" data-tab="all">Все ошибки</div>
                <div class="errors-tab" data-tab="critical">Критические</div>
                <div class="errors-tab" data-tab="ai">AI ошибки</div>
                <div class="errors-tab" data-tab="resolved">Решенные</div>
            </div>
            <button class="refresh-btn" onclick="refreshErrors()">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
        </div>
        
        <div class="errors-scroll-area">
            <div class="errors-section">
                
                <div class="filters-section">
                    <div class="filters-row">
                        <div class="filter-group">
                            <label class="filter-label">Статус</label>
                            <select class="filter-select" id="status-filter">
                                <option value="">Все статусы</option>
                                <option value="new">Новые</option>
                                <option value="in-progress">В работе</option>
                                <option value="resolved">Решенные</option>
                                <option value="ignored">Игнорированные</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Модуль</label>
                            <select class="filter-select" id="module-filter">
                                <option value="">Все модули</option>
                                <option value="ai_service">AI Service</option>
                                <option value="message_processor">Message Processor</option>
                                <option value="catalog_service">Catalog Service</option>
                                <option value="order_service">Order Service</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Период</label>
                            <select class="filter-select" id="period-filter">
                                <option value="1h">Последний час</option>
                                <option value="24h" selected>Последние 24 часа</option>
                                <option value="7d">Последние 7 дней</option>
                                <option value="30d">Последние 30 дней</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="errors-list"></div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'all';
        let errors = [];
        
        // Загрузка ошибок
        async function loadErrors() {
            try {
                const response = await fetch('/api/errors');
                const data = await response.json();
                // Обрабатываем как массив напрямую
                errors = Array.isArray(data) ? data : (data.errors || []);
                console.log(`Loaded ${errors.length} errors`);
                updateStats();
                renderErrors();
            } catch (error) {
                console.error('Error loading errors:', error);
                errors = [];
                updateStats();
                renderErrors();
            }
        }
        
        // Обновление статистики (убрано)
        function updateStats() {
            // Статистика больше не отображается
        }
        
        // Рендеринг ошибок
        function renderErrors() {
            const filteredErrors = filterErrors();
            renderErrorList('errors-list', filteredErrors);
        }
        
        // Фильтрация ошибок
        function filterErrors() {
            let filtered = errors;
            
            // Фильтр по вкладке
            if (currentTab === 'critical') {
                filtered = filtered.filter(e => e.severity === 'critical');
            } else if (currentTab === 'ai') {
                filtered = filtered.filter(e => e.module === 'ai_service');
            } else if (currentTab === 'resolved') {
                filtered = filtered.filter(e => e.status === 'resolved');
            }
            
            // Фильтр по статусу
            const statusFilter = document.getElementById('status-filter').value;
            if (statusFilter) {
                filtered = filtered.filter(e => e.status === statusFilter);
            }
            
            // Фильтр по модулю
            const moduleFilter = document.getElementById('module-filter').value;
            if (moduleFilter) {
                filtered = filtered.filter(e => e.module === moduleFilter);
            }
            
            return filtered;
        }
        
        // Рендеринг списка ошибок
        function renderErrorList(containerId, errorList) {
            const container = document.getElementById(containerId);
            
            if (errorList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <h3>Нет ошибок</h3>
                        <p>Все работает корректно</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = errorList.map(error => `
                <div class="error-card ${error.status}" data-error-id="${error.id}">
                    <div class="error-header">
                        <div class="error-info">
                            <div class="error-title">${error.error_type || 'Ошибка'}</div>
                            <div class="error-message">${error.error_message || error.error}</div>
                            <div class="error-meta">
                                <div class="error-time">
                                    <i class="fas fa-clock"></i>
                                    ${formatTime(error.timestamp)}
                                </div>
                                <div class="error-module">
                                    <i class="fas fa-cube"></i>
                                    ${error.module || 'Неизвестно'}
                                </div>
                                ${error.sender_id ? `
                                    <div class="error-user">
                                        <i class="fas fa-user"></i>
                                        ${error.sender_id}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="error-status status-${error.status}">
                            ${getStatusText(error.status)}
                        </div>
                        <div class="error-actions">
                            ${error.status !== 'resolved' ? `
                                <div class="btn-icon resolve" onclick="resolveError('${error.id}')" title="Решить">
                                    <i class="fas fa-check"></i>
                                </div>
                            ` : ''}
                            ${error.status !== 'ignored' ? `
                                <div class="btn-icon ignore" onclick="ignoreError('${error.id}')" title="Игнорировать">
                                    <i class="fas fa-times"></i>
                                </div>
                            ` : ''}
                            <div class="btn-icon" onclick="showErrorDetails('${error.id}')" title="Детали">
                                <i class="fas fa-eye"></i>
                            </div>
                        </div>
                    </div>
                    ${error.context_data ? `
                        <div class="error-details" style="display: none;" id="details-${error.id}">
                            <strong>Контекст:</strong>
                            <pre>${JSON.stringify(error.context_data, null, 2)}</pre>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Переключение вкладок
        document.querySelectorAll('.errors-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.errors-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;
                renderErrors();
            });
        });
        
        // Переключение секций
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('i');
            
            content.classList.toggle('show');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        }
        
        // Фильтры
        document.getElementById('status-filter').addEventListener('change', renderErrors);
        document.getElementById('module-filter').addEventListener('change', renderErrors);
        document.getElementById('period-filter').addEventListener('change', loadErrors);
        
        // Действия с ошибками
        async function resolveError(errorId) {
            try {
                await fetch(`/api/errors/${errorId}/resolve`, { method: 'POST' });
                loadErrors();
            } catch (error) {
                console.error('Error resolving error:', error);
            }
        }
        
        async function ignoreError(errorId) {
            try {
                await fetch(`/api/errors/${errorId}/ignore`, { method: 'POST' });
                loadErrors();
            } catch (error) {
                console.error('Error ignoring error:', error);
            }
        }
        
        function showErrorDetails(errorId) {
            const details = document.getElementById(`details-${errorId}`);
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Обновление
        function refreshErrors() {
            loadErrors();
        }
        
        // Утилиты
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('ru-RU');
        }
        
        function getStatusText(status) {
            const statusMap = {
                'new': 'Новая',
                'in-progress': 'В работе',
                'resolved': 'Решена',
                'ignored': 'Игнорирована'
            };
            return statusMap[status] || status;
        }
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            loadErrors();
            // Автообновление каждые 30 секунд
            setInterval(loadErrors, 30000);
        });
    </script>
</body>
</html> 