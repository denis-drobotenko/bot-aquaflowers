[2025-07-08T04:16:26.499909+00:00] 04:16:26 | üì® MESSAGE | wamid:wamid.HBgLNzkxNDA3NzU3MTIVAgASGBQzQTFGMTQ5ODQ1N0REMUQ3QzM5QQA=
[2025-07-08T04:16:26.500035+00:00] 04:16:26 | üîÑ NEW MESSAGE FLOW | wamid:wamid.HBgLNzkxNDA3NzU3MTIVAgASGBQzQTFGMTQ5ODQ1N0REMUQ3QzM5QQA=
[2025-07-08T04:16:26.500151+00:00] 04:16:26 | ‚úÖ VALID | type:message | message_type:text
[2025-07-08T04:16:26.545460+00:00] [ERROR_ROUTES] API returning 4 errors
[2025-07-08T04:16:26.545464+00:00] [WEBHOOK] –ò–∑–≤–ª–µ—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: 79140775712 -> –ü—Ä–∏–≤–µ—Ç...
[2025-07-08T04:16:26.545471+00:00] [2025-07-08 04:16:26] INFO: root - {"event": "function_start", "module": "message_processor", "function": "process_user_message", "timestamp": "2025-07-08T04:16:26.546568", "parameters": {"self": "<src.services.message_processor.MessageProcessor object at 0x3e29d670aa10>", "message_data": {"sender_id": "79140775712", "message_text": "–ü—Ä–∏–≤–µ—Ç", "message_type": "text", "sender_name": "Denis", "wa_message_id": "wamid.HBgLNzkxNDA3NzU3MTIVAgASGBQzQTFGMTQ5ODQ1N0REMUQ3QzM5QQA=", "timestamp": "1751948185", "reply_to_message_id": null}}}
[2025-07-08T04:16:26.545527+00:00] 04:16:26 | ü§ñ AI_START | sender:79140775712 | text:–ü—Ä–∏–≤–µ—Ç
[2025-07-08T04:16:27.471722+00:00] [2025-07-08 04:16:27] INFO: httpx - HTTP Request: POST https://graph.facebook.com/v23.0/494991623707876/messages "HTTP/1.1 200 OK"
[2025-07-08T04:16:27.473099+00:00] 04:16:27 | üìã STATUS | type:read | sender:79140775712
[2025-07-08T04:16:27.868916+00:00] [2025-07-08 04:16:27] INFO: httpx - HTTP Request: POST https://graph.facebook.com/v23.0/494991623707876/messages "HTTP/1.1 200 OK"
[2025-07-08T04:16:27.869728+00:00] 04:16:27 | üìã STATUS | type:typing | sender:79140775712
[2025-07-08T04:16:28.813384+00:00] Found valid session: 20250708_034543_609361_100 for 79140775712
[2025-07-08T04:16:28.813407+00:00] Retrieved order: orders/79140775712/sessions/20250708_034543_609361_100
[2025-07-08T04:16:28.813411+00:00] Updated order: orders/79140775712/sessions/20250708_034543_609361_100
[2025-07-08T04:16:28.813416+00:00] [SYNC] Retrieved user language: 79140775712/20250708_034543_609361_100 -> ru
[2025-07-08T04:16:28.813421+00:00] [2025-07-08 04:16:28] INFO: root - {"event": "function_start", "module": "ai_service", "function": "translate_user_message", "timestamp": "2025-07-08T04:16:28.814376", "parameters": {"self": "<src.services.ai_service.AIService object at 0x3e29d6709e50>", "text": "–ü—Ä–∏–≤–µ—Ç", "user_lang": "ru"}}
[2025-07-08T04:16:28.813499+00:00] [2025-07-08 04:16:28] INFO: root - {"event": "function_start", "module": "ai_service", "function": "translate_text", "timestamp": "2025-07-08T04:16:28.814664", "parameters": {"self": "<src.services.ai_service.AIService object at 0x3e29d6709e50>", "text": "–ü—Ä–∏–≤–µ—Ç", "source_lang": "ru", "target_lang": "en"}}
[2025-07-08T04:16:29.582800+00:00] [2025-07-08 04:16:29] INFO: root - {"event": "function_end", "module": "ai_service", "function": "translate_text", "timestamp": "2025-07-08T04:16:29.584178", "execution_time_ms": 769.32, "result": "Hello"}
[2025-07-08T04:16:29.582881+00:00] [2025-07-08 04:16:29] INFO: root - {"event": "function_start", "module": "ai_service", "function": "translate_text", "timestamp": "2025-07-08T04:16:29.584489", "parameters": {"self": "<src.services.ai_service.AIService object at 0x3e29d6709e50>", "text": "–ü—Ä–∏–≤–µ—Ç", "source_lang": "ru", "target_lang": "th"}}
[2025-07-08T04:16:30.706268+00:00] [2025-07-08 04:16:30] INFO: root - {"event": "function_end", "module": "ai_service", "function": "translate_text", "timestamp": "2025-07-08T04:16:30.707702", "execution_time_ms": 1123.08, "result": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ"}
[2025-07-08T04:16:30.706332+00:00] [2025-07-08 04:16:30] INFO: root - {"event": "function_end", "module": "ai_service", "function": "translate_user_message", "timestamp": "2025-07-08T04:16:30.707957", "execution_time_ms": 1893.32, "result": ["–ü—Ä–∏–≤–µ—Ç", "Hello", "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ"]}
[2025-07-08T04:16:31.521951+00:00] [SYNC] Saved user info: 79140775712 -> Denis
[2025-07-08T04:16:31.521970+00:00] [SYNC] Message saved to 79140775712/20250708_034543_609361_100 with wa_id: wamid.HBgLNzkxNDA3NzU3MTIVAgASGBQzQTFGMTQ5ODQ1N0REMUQ3QzM5QQA=
[2025-07-08T04:16:31.521973+00:00] [SYNC] Retrieved 2 messages in transaction
[2025-07-08T04:16:31.521977+00:00] Retrieved 2 messages for sender 79140775712, session 20250708_034543_609361_100
[2025-07-08T04:16:31.521985+00:00] Retrieved user language: 79140775712/20250708_034543_609361_100 -> ru
[2025-07-08T04:16:31.521993+00:00] [2025-07-08 04:16:31] INFO: root - {"event": "function_start", "module": "ai_service", "function": "generate_response", "timestamp": "2025-07-08T04:16:31.522783", "parameters": {"self": "<src.services.ai_service.AIService object at 0x3e29d6709e50>", "messages": ["Message(sender_id='79140775712', session_id='20250708_034543_609361_100', role=<MessageRole.USER: 'user'>, content='–î–æ–±—Ä—ã–π –¥–µ–Ω—å, —Ö–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å –±—É–∫–µ—Ç', timestamp=datetime.datetime(2025, 7, 8, 4, 16, 31, 477809), content_en=\"Good day, I'd like to order a bouquet.\", content_thai='‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏≠‡∏¢‡∏≤‡∏Å‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á‡∏ä‡πà‡∏≠‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ', id=None, wa_message_id=None, parts=None)", "Message(sender_id='79140775712', session_id='20250708_034543_609361_100', role=<MessageRole.USER: 'user'>, content='–ü—Ä–∏–≤–µ—Ç', timestamp=datetime.datetime(2025, 7, 8, 4, 16, 31, 477821), content_en='Hello', content_thai='‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ', id=None, wa_message_id=None, parts=None)"], "user_lang": "ru", "sender_name": "Denis", "is_first_message": false}}
[2025-07-08T04:16:32.715798+00:00] [AI_HISTORY] –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è AI:
[2025-07-08T04:16:32.715816+00:00]  1. [user] –î–æ–±—Ä—ã–π –¥–µ–Ω—å, —Ö–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å –±—É–∫–µ—Ç
[2025-07-08T04:16:32.715820+00:00]  2. [user] –ü—Ä–∏–≤–µ—Ç
[2025-07-08T04:16:32.715827+00:00] [CATALOG_DEBUG] –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ 742818811434193...
[2025-07-08T04:16:32.715831+00:00] [CATALOG_DEBUG] –ü–æ–ª—É—á–µ–Ω–æ 7 —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
[2025-07-08T04:16:32.715838+00:00] [CATALOG_DEBUG] –ü–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä: {'id': '30201199346192629', 'name': 'Pink peony 15', 'description': '.', 'price': '4\xa0500,00\xa0‡∏ø', 'retailer_id': 'b86uuq62na', 'image_url': 'https://scontent-sof1-2.xx.fbcdn.net/v/t45.5328-4/513542842_1225587312139599_3737957355289255307_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=c7e7b7&_nc_ohc=z7EHSqMiZoUQ7kNvwGUs-fW&_nc_oc=Adnl45Id93_hU3e0HYPQ6ZKBphUFMmiMkr6rixMu8CigCwXfKGRCmnvDtUlKYYkBxTXPZv8ptyFPs1ECy3gmfXN5&_nc_zt=23&_nc_ht=scontent-sof1-2.xx&edm=ANyJclEEAAAA&_nc_gid=BW6kSvVZP9E6Kqu6GBFIbA&oh=00_AfTPOLgULcTtr9M9GMaAwwHpWM8pKwCvMvo4DCgvRKzXIw&oe=6872748F', 'availability': 'out of stock'}
[2025-07-08T04:16:32.715842+00:00] [PROMPT_LOAD] Successfully loaded structured prompt from: /app/src/services/prompts/ai_system_prompt.prompt
[2025-07-08T04:16:32.715863+00:00] [AI_REQUEST] RequestID: 3d0a6e3c | Error generating response: '\n  "text"'
[2025-07-08T04:16:32.715875+00:00] [ERROR_SERVICE] Logged error P4E50LroF1UbJTAPtMtV: Exception - AI service error: '\n  "text"'
[2025-07-08T04:16:32.715881+00:00] [AI_ERROR_LOGGED] Error logged to Errors system: AI service error: '\n  "text"'
[2025-07-08T04:16:32.715885+00:00] [2025-07-08 04:16:32] INFO: root - {"event": "function_end", "module": "ai_service", "function": "generate_response", "timestamp": "2025-07-08T04:16:32.717074", "execution_time_ms": 1193.95, "result": ["", "", "", null]}
[2025-07-08T04:16:32.957084+00:00] [MESSAGE_PROCESSOR] AI returned empty response - logging error, NOT sending fallback
[2025-07-08T04:16:32.957123+00:00] [ERROR_SERVICE] Logged error 8wDqpBWHwdHcOKzWjDTV: Exception - AI returned empty response (no text, no command)
[2025-07-08T04:16:32.957153+00:00] [2025-07-08 04:16:32] INFO: root - {"event": "function_end", "module": "message_processor", "function": "process_user_message", "timestamp": "2025-07-08T04:16:32.958254", "execution_time_ms": 6411.37, "result": true}
