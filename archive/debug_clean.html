<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Interface</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f2f2f7;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 10px auto;
            padding: 10px 20px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 320px 400px 1fr;
            gap: 20px;
            height: 90vh;
        }
        
        .panel {
            background: #fff;
            border-radius: 12px;
            padding: 20px 18px 18px 18px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            overflow-y: auto;
        }
        
        .stats {
            background: #f7f7fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 16px;
            color: #333;
            text-align: center;
            font-size: 14px;
        }
        
        #session-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        #session-list li {
            background: #f8f9fa;
            border-radius: 7px;
            padding: 10px 14px;
            margin-bottom: 7px;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            color: #222;
            font-size: 15px;
            transition: background 0.2s, color 0.2s;
        }
        
        #session-list li:hover {
            background: #e9ecef;
            color: #007AFF;
        }
        
        #session-list li.active {
            background: #007AFF;
            color: #fff;
            border-color: #007AFF;
        }
        
        #loadLogsBtn, #newSessionIdBtn {
            background: #e0e0e0;
            color: #222;
            border: none;
            padding: 12px 0;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            margin-top: 4px;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            width: 100%;
            cursor: pointer;
        }
        
        #loadLogsBtn:hover, #newSessionIdBtn:hover {
            background: #bdbdbd;
        }
        
        label {
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
            display: block;
        }
        
        input[type="number"] {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 4px 8px;
            font-size: 15px;
            width: 70px;
            margin-left: 6px;
        }
        
        h3 {
            color: #222;
            font-size: 20px;
            margin-bottom: 12px;
            font-weight: 700;
        }
        
        .refresh-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .session-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e9ecef;
        }
        
        .session-item:hover {
            background: #e9ecef;
        }
        
        .session-item.active {
            background: #007AFF;
            color: white;
        }
        
        .session-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .session-avatar {
            width: 32px;
            height: 32px;
            background: #007AFF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }
        
        .session-info {
            flex: 1;
            min-width: 0;
        }
        
        .session-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .session-preview {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .session-time {
            font-size: 11px;
            color: #999;
            text-align: right;
            flex-shrink: 0;
        }
        
        .session-item.active .session-name,
        .session-item.active .session-preview,
        .session-item.active .session-time {
            color: white;
        }
        
        .message.assistant {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .message.assistant:hover {
            opacity: 0.8;
        }
        
        .message.assistant.has-history {
            border: 2px solid #007AFF;
        }
        
        .ai-history-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .ai-history-item:hover {
            background: #e9ecef;
        }
        
        .ai-history-item.active {
            background: #007AFF;
            color: white;
        }
        
        .ai-history-status {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .ai-history-time {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 2px;
        }
        
        .ai-history-logger {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        .ai-history-data {
            font-size: 11px;
            color: #333;
            margin-top: 4px;
            padding: 4px;
            background: #f8f9fa;
            border-radius: 3px;
            border-left: 3px solid #007bff;
        }
        
        .ai-history-data.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .ai-history-details {
            font-size: 10px;
            color: #666;
            margin-top: 8px;
            padding: 8px;
            background: #f1f3f4;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .ai-history-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }
        
        .ai-history-pagination button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .ai-history-pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 18px;
            position: relative;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message.user {
            background: #007AFF;
            color: white;
            margin-left: auto;
            margin-right: 0;
        }
        
        .message.assistant {
            background: #E9E9EB;
            color: #000;
            margin-left: 0;
            margin-right: auto;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .message-role {
            font-weight: 500;
            font-size: 11px;
            opacity: 0.8;
        }
        
        .message-time {
            font-size: 10px;
            opacity: 0.7;
        }
        
        .message-content {
            line-height: 1.4;
            white-space: pre-wrap;
            font-size: 14px;
        }
        
        .message-hint {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
            text-align: center;
        }
        
        .reply-info {
            font-size: 12px;
            color: #2196F3;
            margin-bottom: 8px;
            font-weight: 500;
            background: rgba(33, 150, 243, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #2196F3;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .stats {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }
        
        .ai-stage-label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 2px;
            color: #fff;
            display: inline-block;
            padding: 2px 8px;
            border-radius: 8px 8px 8px 0;
        }
        .ai-stage-send .ai-stage-label { background: #007bff; }
        .ai-stage-response .ai-stage-label { background: #28a745; }
        .ai-stage-process .ai-stage-label { background: #ff9800; }
        .ai-func-file {
            font-size: 11px;
            color: #555;
            margin-top: 4px;
            background: #e9ecef;
            border-radius: 3px;
            padding: 2px 6px;
            display: inline-block;
        }
        
        .ai-type {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
            font-style: italic;
        }
        
        .ai-history-group {
            margin-bottom: 20px;
        }
        
        .ai-group-separator hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 15px 0;
        }
        
        .ai-request-id {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
            background: #f0f0f0;
            border-radius: 3px;
            padding: 2px 6px;
            display: inline-block;
        }
        
        .ai-group-header {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        
        .ai-status-description {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
            font-style: italic;
        }
        
        .deploy-btn {
            background: linear-gradient(45deg, #7b2ff2, #f357a8);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 16px;
            font-size: 15px;
            font-weight: bold;
            width: 100%;
            box-shadow: 0 2px 10px rgba(123,47,242,0.15);
            letter-spacing: 0.5px;
        }
        .deploy-btn:hover {
            background: linear-gradient(45deg, #f357a8, #7b2ff2);
            box-shadow: 0 4px 16px rgba(123,47,242,0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="grid">
            <div class="panel">
                <h3>–°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                <div class="stats" id="stats">
                    <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
                </div>
                <div style="margin: 16px 0; display: flex; flex-direction: column; gap: 10px;">
                    <label>–ü–µ—Ä–∏–æ–¥ (–º–∏–Ω—É—Ç): <input type="number" id="logPeriodInput" value="20" min="1" max="1440" style="width:60px;"></label>
                    <button id="loadLogsBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏</button>
                    <button id="newSessionIdBtn">–ù–æ–≤—ã–π session_id –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                </div>
                <ul id="session-list"></ul>
            </div>
            
            <div class="panel">
                <h3>–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∏–∞–ª–æ–≥–∞</h3>
                <div id="dialog-content">
                    <div class="empty-state">
                        –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∏–∞–ª–æ–≥–∞
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>–ò—Å—Ç–æ—Ä–∏—è AI</h3>
                <div id="ai-history-content">
                    <div class="empty-state">
                        –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ AI —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let serverLogs = [];
        let currentMessages = [];
        let currentAiHistoryIndex = -1;
        let currentHistoryPage = 0;
        const SERVER_URL = 'https://auraflora-bot-75152239022.asia-southeast1.run.app';
        
        async function loadLogsFromServer() {
            try {
                const period = parseInt(document.getElementById('logPeriodInput').value) || 20;
                console.log('–ó–∞–≥—Ä—É–∂–∞—é –ª–æ–≥–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥:', period, '–º–∏–Ω—É—Ç...');
                document.getElementById('stats').innerHTML = '<div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                const response = await fetch(SERVER_URL + '/api/debug/logs?period_min=' + period);
                const data = await response.json();
                serverLogs = data.logs || [];
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ ' + serverLogs.length + ' –ª–æ–≥–æ–≤');
                document.getElementById('stats').innerHTML = '<div>–õ–æ–≥–æ–≤: ' + serverLogs.length + '</div>';
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª
                await saveLogsToServer();
                
                await loadSessions();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('stats').innerHTML = '<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }
        
        function buildSessionsFromLogs(logs) {
            console.log('üîç buildSessionsFromLogs: –Ω–∞—á–∞–ª–æ –ø–∞—Ä—Å–∏–Ω–≥–∞', logs.length, '–ª–æ–≥–æ–≤');
            const sessions = {};
            
            // –ò—â–µ–º session_id –≤ –ª–æ–≥–∞—Ö
            logs.forEach(function(log, index) {
                const message = log.message || log.textPayload || '';
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
                if (message.includes('[DEBUG_LOGS]') || 
                    message.includes('INFO:src.main:') || 
                    message.includes('INFO: ') ||
                    message.includes('WARNING: ') ||
                    message.includes('ERROR: ') ||
                    message.includes('"POST /webhook HTTP/1.1"') ||
                    message.includes('"GET /') ||
                    message.includes('INFO:src.webhook_handlers:')) {
                    return;
                }
                console.log(`üìù –õ–æ–≥ ${index + 1}:`, message.substring(0, 100) + '...');
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º session_id –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
                let sessionId = log.session_id;
                if (!sessionId) {
                    // –ò—â–µ–º –≤ —Ç–µ–∫—Å—Ç–µ –ª–æ–≥–∞ - –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è Session
                    const sessionMatch = message.match(/Session[:\s]+([^\s,|]+)/);
                    if (sessionMatch) {
                        sessionId = sessionMatch[1];
                        console.log('‚úÖ –ù–∞–π–¥–µ–Ω session_id –≤ —Ç–µ–∫—Å—Ç–µ:', sessionId);
                    }
                }
                
                // –ï—Å–ª–∏ session_id –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ª–æ–≥
                if (!sessionId) {
                    return;
                }
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ sender_id (–ø–µ—Ä–≤–∞—è —á–∞—Å—Ç—å session_id)
                const senderId = sessionId.split('_')[0] || sessionId;
                
                if (!sessions[senderId]) {
                    sessions[senderId] = {
                        session_id: sessionId, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π session_id
                        sender_id: senderId,
                        message_count: 0,
                        last_message_time: log.timestamp,
                        unique_messages: new Set() // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                    };
                    console.log('üÜï –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è:', senderId, '—Å session_id:', sessionId);
                }
                
                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (message.includes('[WEBHOOK_RAW_MESSAGE]') && (message.includes('"text"') || message.includes("'text'"))) {
                    const content = extractUserMessageFromLog(message);
                    if (content) {
                        sessions[senderId].unique_messages.add(content);
                        sessions[senderId].message_count = sessions[senderId].unique_messages.size;
                        console.log('üí¨ –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏—é', senderId, ':', content.substring(0, 50));
                    }
                }
                
                if (log.timestamp > sessions[senderId].last_message_time) {
                    sessions[senderId].last_message_time = log.timestamp;
                }
            });
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
            const sessionsList = Object.values(sessions).map(session => {
                delete session.unique_messages; // –£–±–∏—Ä–∞–µ–º Set –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                return session;
            });
            
            sessionsList.sort(function(a, b) {
                return new Date(b.last_message_time) - new Date(a.last_message_time);
            });
            
            console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞:', sessionsList.length, '—Å–µ—Å—Å–∏–π:', sessionsList);
            return sessionsList;
        }
        
        function buildMessagesFromLogs(sessionId, logs) {
            const messages = [];
            const seenMessages = new Set(); // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            
            // –ò—â–µ–º –ª–æ–≥–∏ –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ (–ø–æ sender_id)
            let sessionLogs = [];
            const senderId = sessionId.split('_')[0] || sessionId;
            
            for (const log of logs) {
                const message = log.message || log.textPayload || '';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º session_id
                if (log.session_id && log.session_id.startsWith(senderId)) {
                    sessionLogs.push(log);
                    continue;
                }
                
                // –ò—â–µ–º session_id –≤ —Ç–µ–∫—Å—Ç–µ –ª–æ–≥–∞
                const sessionMatch = message.match(/Session[:\s]+([^\s,|]+)/);
                if (sessionMatch && sessionMatch[1].startsWith(senderId)) {
                    sessionLogs.push(log);
                    continue;
                }
                
                // –ò—â–µ–º –ø–æ sender_id –≤ webhook –¥–∞–Ω–Ω—ã—Ö - –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫
                // –ò—â–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–π from, –Ω–µ context.from
                const webhookMatch = message.match(/['"]from['"]\s*:\s*['"]([^'"]+)['"]/);
                if (webhookMatch && webhookMatch[1].match(/^\d+$/) && webhookMatch[1] !== '66963617068' && webhookMatch[1] === senderId) {
                    sessionLogs.push(log);
                    continue;
                }
            }
            
            console.log(`–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é ${sessionLogs.length} –ª–æ–≥–æ–≤ –¥–ª—è —Å–µ—Å—Å–∏–∏ ${sessionId}`);
            
            // –ò—â–µ–º –ª–æ–≥–∏ —Å AI –æ—Ç–≤–µ—Ç–∞–º–∏ –≤–æ –≤—Å–µ—Ö –ª–æ–≥–∞—Ö, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –≤ —Å–µ—Å—Å–∏–∏
            const allAiLogs = logs.filter(function(log) {
                const message = log.message || log.textPayload || '';
                return message.includes('[MESSAGE_AI_FINAL_RESULT]') || 
                       message.includes('[MESSAGE_AI_RAW_TEXT]') ||
                       message.includes('[JSON_AI_PARSE_USER_TEXT]') ||
                       message.includes('[JSON_AI_FIX_SUCCESS]') ||
                       message.includes('[WEBHOOK_AI_RESPONSE_TEXT]') ||
                       message.includes('[MESSAGE_SEND_INPUT] Original message:') ||
                       // –°—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                       message.includes('[AI_RESPONSE_GENERATED]') || 
                       message.includes('[AI_FINAL_RESULT]');
            });
            
            console.log('–ù–∞–π–¥–µ–Ω–æ ' + allAiLogs.length + ' –ª–æ–≥–æ–≤ —Å AI –æ—Ç–≤–µ—Ç–∞–º–∏ –≤–æ –≤—Å–µ—Ö –ª–æ–≥–∞—Ö:');
            allAiLogs.forEach(function(log, i) {
                console.log('AI –ª–æ–≥ ' + (i+1) + ':', {
                    logger: log.logger_name,
                    message: log.message
                });
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º AI –ª–æ–≥–∏ –∫ —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–º –ª–æ–≥–∞–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            sessionLogs = sessionLogs.concat(allAiLogs);
            
            sessionLogs.forEach(function(log) {
                const message = log.message || log.textPayload || '';
                const timestamp = log.timestamp;
                const logger = log.logger_name || '';
                
                // –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (message.includes('[WEBHOOK_RAW_MESSAGE]') && (message.includes('"text"') || message.includes("'text'"))) {
                    const content = extractUserMessageFromLog(message);
                    if (content && !seenMessages.has(content)) {
                        seenMessages.add(content);
                        
                        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                        const history = collectMessageHistory(content, sessionLogs, 'user');
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º reply - –∏—â–µ–º WEBHOOK_REPLY –≤ –ª–æ–≥–∞—Ö –≤ –±–ª–∏–∑–∫–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ–∫–Ω–µ
                        let replyTo = null;
                        
                        // –ò—â–µ–º reply –ª–æ–≥–∏ –≤ –æ–∫–Ω–µ ¬±5 —Å–µ–∫—É–Ω–¥ –æ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        const messageTime = new Date(timestamp);
                        const nearbyLogs = sessionLogs.filter(log => {
                            const logTime = new Date(log.timestamp);
                            return Math.abs(logTime - messageTime) < 5000; // 5 —Å–µ–∫—É–Ω–¥
                        });
                        
                        // –ò—â–µ–º reply –≤ –±–ª–∏–∑–∫–∏—Ö –ª–æ–≥–∞—Ö
                        for (const nearbyLog of nearbyLogs) {
                            const nearbyMessage = nearbyLog.message || '';
                            
                            // –ü–æ–∏—Å–∫ WEBHOOK_REPLY
                            const replyMatch = nearbyMessage.match(/\[WEBHOOK_REPLY\] Reply to message ID: ([^\s,]+)/);
                            if (replyMatch) {
                                replyTo = replyMatch[1];
                                break;
                            }
                            
                            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ context.id –≤ JSON
                            const contextMatch = nearbyMessage.match(/"context":\s*{\s*"id":\s*"([^"]+)"/);
                            if (contextMatch) {
                                replyTo = contextMatch[1];
                                break;
                            }
                            
                            // –ü–æ–∏—Å–∫ –≤ –æ–¥–∏–Ω–∞—Ä–Ω—ã—Ö –∫–∞–≤—ã—á–∫–∞—Ö
                            const singleQuoteMatch = nearbyMessage.match(/'context':\s*\{'id':\s*'([^']+)'/);
                            if (singleQuoteMatch) {
                                replyTo = singleQuoteMatch[1];
                                break;
                            }
                        }
                        
                        messages.push({
                            role: 'user',
                            content: content,
                            timestamp: timestamp,
                            history: history,
                            replyTo: replyTo
                        });
                    }
                }
                // AI —Å–æ–æ–±—â–µ–Ω–∏—è - –∫–∞–∂–¥–æ–µ –æ—Ç–¥–µ–ª—å–Ω–æ (–∏—Å–∫–ª—é—á–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —ç—Ç–∞–ø—ã)
                else if (message.includes('[MESSAGE_AI_FINAL_RESULT]') || 
                         message.includes('[AI_RESPONSE_SAVED]') ||
                         message.includes('[AI_RESPONSE_GENERATED]') || 
                         message.includes('[AI_FINAL_RESULT]') ||
                         message.includes('[WEBHOOK_AI_RESPONSE_TEXT]')) {
                    
                    console.log('üîç –ù–∞–π–¥–µ–Ω AI –ª–æ–≥:', message.substring(0, 200) + '...');
                    
                    const content = extractBotResponseFromLog(message);
                    console.log('üìù –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç:', content);
                    
                    if (content && !seenMessages.has(content)) {
                        seenMessages.add(content);
                        
                        console.log('‚úÖ –î–æ–±–∞–≤–ª—è–µ–º AI —Å–æ–æ–±—â–µ–Ω–∏–µ:', content.substring(0, 100) + '...');
                        
                        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                        const history = collectMessageHistory(content, sessionLogs, 'assistant');
                        console.log('üìö –°–æ–±—Ä–∞–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è:', history.length, '—Å–æ–±—ã—Ç–∏–π');
                        
                        messages.push({
                            role: 'assistant',
                            content: content,
                            timestamp: timestamp,
                            history: history
                        });
                    } else {
                        console.log('‚ùå AI —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ:', content ? '—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' : '–ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç');
                    }
                }
            });
            
            messages.sort(function(a, b) {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });
            
            console.log('–ü–æ—Å—Ç—Ä–æ–µ–Ω–æ ' + messages.length + ' —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π');
            return messages;
        }
        
        function extractUserMessageFromLog(logMessage) {
            console.log('üîç extractUserMessageFromLog:', logMessage.substring(0, 100) + '...');
            try {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: 'text': {'body': '–ü—Ä–∏–≤–µ—Ç'}
                const jsonMatch = logMessage.match(/'text':\s*\{'body':\s*'([^']+)'/);
                if (jsonMatch) {
                    const result = jsonMatch[1].trim();
                    console.log('‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø–∞—Ç—Ç–µ—Ä–Ω 1):', result);
                    return result;
                }
                
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω —Å –¥–≤–æ–π–Ω—ã–º–∏ –∫–∞–≤—ã—á–∫–∞–º–∏
                const jsonMatch2 = logMessage.match(/"text":\s*{\s*"body":\s*"([^"]+)"/);
                if (jsonMatch2) {
                    const result = jsonMatch2[1].trim();
                    console.log('‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø–∞—Ç—Ç–µ—Ä–Ω 2):', result);
                    return result;
                }
                
                console.log('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ª–æ–≥–µ');
                return "";
                
            } catch (e) {
                console.error('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
                return "";
            }
        }
        
        function extractBotResponseFromLog(logMessage) {
            console.log('üîç extractBotResponseFromLog:', logMessage.substring(0, 200) + '...');
            try {
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
                function decodeText(text) {
                    if (!text) return '';
                    return text
                        .replace(/\\xa0/g, ' ') // –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª
                        .replace(/\\n/g, '\n') // –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
                        .replace(/\\t/g, '\t') // —Ç–∞–±—É–ª—è—Ü–∏—è
                        .replace(/\\"/g, '"') // –∫–∞–≤—ã—á–∫–∏
                        .replace(/\\\\/g, '\\') // –æ–±—Ä–∞—Ç–Ω—ã–π —Å–ª–µ—à
                        .replace(/\\u([0-9a-fA-F]{4})/g, (match, hex) => String.fromCharCode(parseInt(hex, 16))) // Unicode
                        .trim();
                }
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π)
                const messageAiMatch = logMessage.match(/\[MESSAGE_AI_FINAL_RESULT\].*?Text:\s*(.+?)(?:,\s*Command:|$)/);
                if (messageAiMatch) {
                    const decodedText = decodeText(messageAiMatch[1]);
                    console.log('‚úÖ –ù–∞–π–¥–µ–Ω MESSAGE_AI_FINAL_RESULT:', decodedText);
                    return decodedText;
                }
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
                const aiSavedMatch = logMessage.match(/\[AI_RESPONSE_SAVED\].*?Text:\s*(.+?)(?:\s*\|\s*Message ID:|$)/);
                if (aiSavedMatch) {
                    console.log('‚úÖ –ù–∞–π–¥–µ–Ω AI_RESPONSE_SAVED:', aiSavedMatch[1].trim());
                    return aiSavedMatch[1].trim();
                }
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
                const aiGeneratedMatch = logMessage.match(/\[AI_RESPONSE_GENERATED\].*?Text:\s*(.+?)(?:\s*\|\s*Command:|$)/);
                if (aiGeneratedMatch) {
                    return aiGeneratedMatch[1].trim();
                }
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
                const aiMatch = logMessage.match(/\[AI_FINAL_RESULT\] Text:\s*(.+?)(?:,\s*Command:|$)/);
                if (aiMatch) {
                    return aiMatch[1].trim();
                }
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 5: Webhook –æ—Ç–≤–µ—Ç
                const responseMatch = logMessage.match(/\[WEBHOOK_AI_RESPONSE_TEXT\]\s*(.+)/);
                if (responseMatch) {
                    return responseMatch[1].trim();
                }
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 6: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const sendMatch = logMessage.match(/\[MESSAGE_SEND_INPUT\] Original message:\s*(.+)/);
                if (sendMatch) {
                    return sendMatch[1].trim();
                }
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 7: JSON AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö)
                const jsonAiMatch = logMessage.match(/\[JSON_AI_PARSE_USER_TEXT\].*?\| (.+)/);
                if (jsonAiMatch) {
                    return jsonAiMatch[1].trim();
                }
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 8: –°—ã—Ä–æ–π —Ç–µ–∫—Å—Ç (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –∏ —ç—Ç–æ –Ω–µ JSON)
                const messageAiRawMatch = logMessage.match(/\[MESSAGE_AI_RAW_TEXT\].*?\| (.+)/);
                if (messageAiRawMatch) {
                    const rawText = messageAiRawMatch[1].trim();
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ JSON –∫–æ–¥
                    if (!rawText.startsWith('```json') && !rawText.startsWith('{') && !rawText.startsWith('[')) {
                        return rawText;
                    }
                }
                
            } catch (e) {
                console.error('Error:', e);
            }
            return '';
        }
        
        function extractAiStatus(message) {
            if (message.includes('[MESSAGE_AI_REQUEST_START]')) return 'MESSAGE_AI_REQUEST_START';
            if (message.includes('[MESSAGE_AI_REQUEST_HISTORY]')) return 'MESSAGE_AI_REQUEST_HISTORY';
            if (message.includes('[MESSAGE_AI_SYSTEM_INSTRUCTION]')) return 'MESSAGE_AI_SYSTEM_INSTRUCTION';
            if (message.includes('[MESSAGE_AI_FILTERED_HISTORY]')) return 'MESSAGE_AI_FILTERED_HISTORY';
            if (message.includes('[MESSAGE_AI_GEMINI_REQUEST]')) return 'MESSAGE_AI_GEMINI_REQUEST';
            if (message.includes('[MESSAGE_AI_RAW_RESPONSE]')) return 'MESSAGE_AI_RAW_RESPONSE';
            if (message.includes('[MESSAGE_AI_RAW_TEXT]')) return 'MESSAGE_AI_RAW_TEXT';
            if (message.includes('[MESSAGE_AI_FINAL_RESULT]')) return 'MESSAGE_AI_FINAL_RESULT';
            if (message.includes('[MESSAGE_AI_REQUEST_END]')) return 'MESSAGE_AI_REQUEST_END';
            if (message.includes('[MESSAGE_AI_REQUEST_EXCEPTION]')) return 'MESSAGE_AI_REQUEST_EXCEPTION';
            
            if (message.includes('[JSON_AI_EXTRACT_START]')) return 'JSON_AI_EXTRACT_START';
            if (message.includes('[JSON_AI_EXTRACT_INPUT]')) return 'JSON_AI_EXTRACT_INPUT';
            if (message.includes('[JSON_AI_EXTRACT_STEP1]')) return 'JSON_AI_EXTRACT_STEP1';
            if (message.includes('[JSON_AI_EXTRACT_STEP2]')) return 'JSON_AI_EXTRACT_STEP2';
            if (message.includes('[JSON_AI_FIX_START]')) return 'JSON_AI_FIX_START';
            if (message.includes('[JSON_AI_FIX_PROMPT]')) return 'JSON_AI_FIX_PROMPT';
            if (message.includes('[JSON_AI_FIX_RAW_RESPONSE]')) return 'JSON_AI_FIX_RAW_RESPONSE';
            if (message.includes('[JSON_AI_FIX_TEXT]')) return 'JSON_AI_FIX_TEXT';
            if (message.includes('[JSON_AI_FIX_SUCCESS]')) return 'JSON_AI_FIX_SUCCESS';
            if (message.includes('[JSON_AI_PARSE_INPUT]')) return 'JSON_AI_PARSE_INPUT';
            if (message.includes('[JSON_AI_PARSE_JSON_DATA]')) return 'JSON_AI_PARSE_JSON_DATA';
            if (message.includes('[JSON_AI_PARSE_USER_TEXT]')) return 'JSON_AI_PARSE_USER_TEXT';
            if (message.includes('[JSON_AI_PARSE_COMMAND]')) return 'JSON_AI_PARSE_COMMAND';
            
            if (message.includes('[WEBHOOK_AI_RESPONSE_TEXT]')) return 'WEBHOOK_AI_RESPONSE_TEXT';
            if (message.includes('[MESSAGE_SEND_INPUT]')) return 'MESSAGE_SEND_INPUT';
            if (message.includes('[MESSAGE_SEND_START]')) return 'MESSAGE_SEND_START';
            return 'OTHER';
        }
        
        function extractRequestId(message) {
            const match = message.match(/RequestID:\s*([a-f0-9]{8})/);
            return match ? match[1] : null;
        }
        
        function extractFuncFile(message) {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∞–π–ª –∏ —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –Ω–∞—á–∞–ª–∞ –ª–æ–≥–∞: [ai_manager.py:get_ai_response:123]
            const match = message.match(/^\[([^:]+):([^:]+):(\d+)\]/);
            if (match) {
                return match[1] + ':' + match[2] + ':' + match[3];
            }
            return '';
        }
        
        function collectMessageHistory(content, sessionLogs, role) {
            const history = [];
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Ä–µ–º—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            const messageTime = new Date(sessionLogs.find(log => 
                log.message && log.message.includes(content) && 
                (log.message.includes('[MESSAGE_AI_FINAL_RESULT]') || 
                 log.message.includes('[AI_RESPONSE_SAVED]') ||
                 log.message.includes('[AI_FINAL_RESULT]') || 
                 log.message.includes('[AI_RESPONSE_GENERATED]'))
            )?.timestamp || Date.now());
            
            // –î–ª—è AI —Å–æ–æ–±—â–µ–Ω–∏–π —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–æ 2 –º–∏–Ω—É—Ç
            const timeWindow = role === 'assistant' ? 120 * 1000 : 30 * 1000; // 2 –º–∏–Ω—É—Ç—ã –¥–ª—è AI, 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
            sessionLogs.forEach(function(log) {
                const message = log.message || log.textPayload || '';
                const timestamp = log.timestamp;
                const logger = log.logger_name || '';
                const logTime = new Date(timestamp);
                
                // –î–ª—è AI —Å–æ–æ–±—â–µ–Ω–∏–π –∏—â–µ–º –ª–æ–≥–∏ –≤–æ–∫—Ä—É–≥ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (¬±2 –º–∏–Ω—É—Ç—ã)
                if (role === 'assistant') {
                    const timeDiff = Math.abs(messageTime - logTime);
                    if (timeDiff <= timeWindow) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –ª–æ–≥ –∫ —ç—Ç–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
                        if (isRelatedToMessage(content, message, logTime, messageTime)) {
                            history.push({
                                status: extractAiStatus(message),
                                timestamp: timestamp,
                                logger: logger,
                                fullMessage: message,
                                extractedData: extractRelevantData(message)
                            });
                        }
                    }
                } else {
                    // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏—â–µ–º –ª–æ–≥–∏ –¥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    if (logTime <= messageTime && (messageTime - logTime) <= timeWindow) {
                        if (isRelatedToMessage(content, message, logTime, messageTime)) {
                            history.push({
                                status: extractAiStatus(message),
                                timestamp: timestamp,
                                logger: logger,
                                fullMessage: message,
                                extractedData: extractRelevantData(message)
                            });
                        }
                    }
                }
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            history.sort(function(a, b) {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });
            
            return history;
        }
        
        function isRelatedToMessage(content, logMessage, logTime, messageTime) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –ª–æ–≥ —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            if (logMessage.includes(content)) return true;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º AI-—Å–≤—è–∑–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
            const timeDiff = Math.abs(messageTime - logTime);
            if (timeDiff <= 120000) { // 2 –º–∏–Ω—É—Ç—ã –¥–ª—è AI –ª–æ–≥–∏–∫–∏
                if (logMessage.includes('[MESSAGE_AI_') || 
                    logMessage.includes('[JSON_AI_') ||
                    logMessage.includes('[WEBHOOK_AI_') || 
                    logMessage.includes('[MESSAGE_SEND_') ||
                    // –°—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    logMessage.includes('[AI_')) {
                    return true;
                }
            }
            
            return false;
        }
        
        function extractRelevantData(message) {
            const data = {};
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–æ–º–ø—Ç –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–Ω–æ–≤—ã–µ –ª–æ–≥–∏)
            const promptMatch = message.match(/\[MESSAGE_AI_SYSTEM_INSTRUCTION\].*?\| (.+)/);
            if (promptMatch) {
                data.prompt = promptMatch[1];
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—ã—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é (–Ω–æ–≤—ã–µ –ª–æ–≥–∏)
            const historyMatch = message.match(/\[MESSAGE_AI_REQUEST_HISTORY\].*?\| (.+)/);
            if (historyMatch) {
                data.chatHistory = historyMatch[1];
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é (–Ω–æ–≤—ã–µ –ª–æ–≥–∏)
            const filteredMatch = message.match(/\[MESSAGE_AI_FILTERED_HISTORY\].*?\| (.+)/);
            if (filteredMatch) {
                data.filteredHistory = filteredMatch[1];
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–æ–≤—ã–µ –ª–æ–≥–∏)
            const jsonPromptMatch = message.match(/\[JSON_AI_FIX_PROMPT\].*?\| (.+)/);
            if (jsonPromptMatch) {
                data.prompt = jsonPromptMatch[1];
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—à–∏–±–∫–∏ (–Ω–æ–≤—ã–µ –ª–æ–≥–∏)
            const errorMatch = message.match(/\[MESSAGE_AI_REQUEST_EXCEPTION\].*?Error: (.+)/);
            if (errorMatch) {
                data.error = errorMatch[1];
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –æ—à–∏–±–∫–∏ (–Ω–æ–≤—ã–µ –ª–æ–≥–∏)
            const jsonErrorMatch = message.match(/\[JSON_AI_.*?_ERROR\].*?\| (.+)/);
            if (jsonErrorMatch) {
                data.error = jsonErrorMatch[1];
            }
            
            // –°—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            const oldPromptMatch = message.match(/\[AI_SYSTEM_INSTRUCTION\].*?\| (.+)/);
            if (oldPromptMatch) {
                data.prompt = oldPromptMatch[1];
            }
            
            const oldHistoryMatch = message.match(/\[AI_REQUEST_HISTORY\].*?\| (.+)/);
            if (oldHistoryMatch) {
                data.chatHistory = oldHistoryMatch[1];
            }
            
            const oldFilteredMatch = message.match(/\[AI_FILTERED_HISTORY\].*?\| (.+)/);
            if (oldFilteredMatch) {
                data.filteredHistory = oldFilteredMatch[1];
            }
            
            const oldErrorMatch = message.match(/\[AI_REQUEST_EXCEPTION\].*?Error: (.+)/);
            if (oldErrorMatch) {
                data.error = oldErrorMatch[1];
            }
            
            return data;
        }
        
        async function loadSessions() {
            console.log('üîÑ loadSessions: –Ω–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–π');
            console.log('üì¶ serverLogs.length:', serverLogs.length);
            
            if (!serverLogs || serverLogs.length === 0) {
                console.log('‚ùå –ù–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–µ—Å—Å–∏–π');
                const sessionsList = document.getElementById('sessions-list');
                if (sessionsList) {
                    sessionsList.innerHTML = '<div class="empty-state">–ù–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>';
                }
                return;
            }
            
            try {
                const sessions = buildSessionsFromLogs(serverLogs);
                console.log('üìã –ü–æ—Å—Ç—Ä–æ–µ–Ω–æ —Å–µ—Å—Å–∏–π:', sessions.length);
                
                if (sessions.length === 0) {
                    console.log('‚ö†Ô∏è –°–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ª–æ–≥–∞—Ö');
                    const sessionsList = document.getElementById('sessions-list');
                    if (sessionsList) {
                        sessionsList.innerHTML = '<div class="empty-state">–°–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ª–æ–≥–∞—Ö</div>';
                    }
                    return;
                }
                
                console.log('üéØ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–µ—Å—Å–∏–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ');
                displaySessions(sessions);
                
            } catch (error) {
                console.error('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Å—Å–∏–π:', error);
                const sessionsList = document.getElementById('sessions-list');
                if (sessionsList) {
                    sessionsList.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Å—Å–∏–π</div>';
                }
            }
        }
       
               function displaySessions(sessions) {
            const sessionList = document.getElementById('session-list');
            if (!sessionList) return;
            sessionList.innerHTML = '';
            
            document.getElementById('stats').innerHTML = '<div>–°–µ—Å—Å–∏–π: ' + sessions.length + '</div><div>–õ–æ–≥–æ–≤: ' + serverLogs.length + '</div>';
            
            sessions.forEach(session => {
                        const sessionName = session.sender_id;
                
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="session-header">
                        <div class="session-avatar">üë§</div>
                        <div class="session-info">
                            <div class="session-name">${sessionName}</div>
                            <div class="session-preview">${session.message_count} —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                        </div>
                        <div class="session-time">${formatTime(session.last_message_time)}</div>
                    </div>
                `;
                li.onclick = () => selectSession(session.session_id);
                sessionList.appendChild(li);
            });
        }
       
       async function selectSession(sessionId) {
            const sessionList = document.getElementById('session-list');
            if (!sessionList) return;
            Array.from(sessionList.children).forEach(li => li.classList.remove('active'));
            const li = Array.from(sessionList.children).find(li => li.textContent === sessionId);
            if (li) li.classList.add('active');
            
            currentSessionId = sessionId;
            currentAiHistoryIndex = -1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            document.getElementById('dialog-content').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            document.getElementById('ai-history-content').innerHTML = '<div class="empty-state">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ AI —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏</div>';
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                if (serverLogs.length === 0) {
                    await loadLogsFromServer();
                }
                
                const messages = buildMessagesFromLogs(sessionId, serverLogs);
                currentMessages = messages; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                displayDialog(messages, serverLogs);
            } catch (error) {
                document.getElementById('dialog-content').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞</div>';
                console.error('Error:', error);
            }
        }
       
       function displayDialog(messages, logs) {
           const container = document.getElementById('dialog-content');
           
           if (messages.length === 0) {
               container.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
               return;
           }
           
                      container.innerHTML = messages.map(function(message, index) {
               if (message.role === 'assistant' && message.history && message.history.length > 1) {
                   return '<div class="message ' + message.role + ' has-history" onclick="showAiHistory(' + index + ')">' +
                       '<div class="message-content">' + escapeHtml(message.content) + '</div>' +
                       '<div class="message-hint">üìã –ò—Å—Ç–æ—Ä–∏—è (' + message.history.length + ' —Å–æ–±—ã—Ç–∏–π)</div>' +
                   '</div>';
               } else if (message.role === 'user' && message.history && message.history.length > 0) {
                   let replyMark = '';
                   if (message.replyTo) {
                       replyMark = '<div class="reply-info">‚Ü©Ô∏è –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + message.replyTo + '</div>';
                   }
                   return '<div class="message ' + message.role + ' has-history" onclick="showUserHistory(' + index + ')">' +
                       replyMark +
                       '<div class="message-content">' + escapeHtml(message.content) + '</div>' +
                       '<div class="message-hint">üìã –ò—Å—Ç–æ—Ä–∏—è (' + message.history.length + ' —Å–æ–±—ã—Ç–∏–π)</div>' +
                   '</div>';
               } else {
                   return '<div class="message ' + message.role + '">' +
                       '<div class="message-content">' + escapeHtml(message.content) + '</div>' +
                   '</div>';
               }
           }).join('');
      }
      
      function formatDateTime(timestamp) {
          return new Date(timestamp).toLocaleString('ru-RU');
      }
      
      function formatTime(timestamp) {
          const date = new Date(timestamp);
          const now = new Date();
          const diffMs = now - date;
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          
          if (diffDays === 0) {
              // –°–µ–≥–æ–¥–Ω—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è
              return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
          } else if (diffDays === 1) {
              // –í—á–µ—Ä–∞
              return '–í—á–µ—Ä–∞';
          } else if (diffDays < 7) {
              // –ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ
              return date.toLocaleDateString('ru-RU', { weekday: 'short' });
          } else {
              // –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
              return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
          }
      }
      
      function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text || '';
          return div.innerHTML;
      }
      
      function showAiHistory(messageIndex) {
          currentAiHistoryIndex = messageIndex;
          currentHistoryPage = 0;
          displayAiHistory();
      }
      
      function displayAiHistory() {
          const container = document.getElementById('ai-history-content');
          
          if (currentAiHistoryIndex === -1 || !currentMessages[currentAiHistoryIndex]) {
              container.innerHTML = '<div class="empty-state">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ AI —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏</div>';
              return;
          }
          
          const message = currentMessages[currentAiHistoryIndex];
          if (!message.history || message.history.length === 0) {
              container.innerHTML = '<div class="empty-state">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</div>';
              return;
          }
          
          const history = message.history;
          
          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ –±–ª–æ–∫–∞–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ AI
          const groupedHistory = groupHistoryByAiRequests(history);
          
          const historyHtml = groupedHistory.map(function(group, groupIndex) {
              const groupHtml = group.events.map(function(entry, index) {
                  let dataHtml = '';
                  let stageLabel = '';
                  let stageClass = '';
                  let aiType = '';
                  
                  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø AI –∏ —ç—Ç–∞–ø
                  if (entry.status.startsWith('MESSAGE_AI_')) {
                      if (entry.status.includes('REQUEST_START') || entry.status.includes('SYSTEM_INSTRUCTION') || entry.status.includes('FILTERED_HISTORY') || entry.status.includes('GEMINI_REQUEST')) {
                          stageLabel = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Message AI';
                          stageClass = 'ai-stage-send';
                          aiType = '–û—Å–Ω–æ–≤–Ω–æ–π AI (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤)';
                      } else if (entry.status.includes('RAW_RESPONSE') || entry.status.includes('RAW_TEXT') || entry.status.includes('FINAL_RESULT')) {
                          stageLabel = '–û—Ç–≤–µ—Ç Message AI';
                          stageClass = 'ai-stage-response';
                          aiType = '–û—Å–Ω–æ–≤–Ω–æ–π AI (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤)';
                      }
                  } else if (entry.status.startsWith('JSON_AI_')) {
                      if (entry.status.includes('EXTRACT_START') || entry.status.includes('FIX_START') || entry.status.includes('FIX_PROMPT')) {
                          stageLabel = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ JSON AI';
                          stageClass = 'ai-stage-send';
                          aiType = 'JSON AI (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ JSON)';
                      } else if (entry.status.includes('FIX_RAW_RESPONSE') || entry.status.includes('FIX_TEXT') || entry.status.includes('FIX_SUCCESS') || entry.status.includes('PARSE_')) {
                          stageLabel = '–û—Ç–≤–µ—Ç JSON AI';
                          stageClass = 'ai-stage-response';
                          aiType = 'JSON AI (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ JSON)';
                      }
                  } else if (entry.status === 'WEBHOOK_AI_RESPONSE_TEXT' || entry.status === 'MESSAGE_SEND_INPUT' || entry.status === 'MESSAGE_SEND_START') {
                      stageLabel = '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞';
                      stageClass = 'ai-stage-process';
                      aiType = 'Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞';
                  }
                  
                  // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏ —Ñ–∞–π–ª
                  let funcFile = extractFuncFile(entry.fullMessage);
                  let requestId = extractRequestId(entry.fullMessage);
                  
                  if (entry.extractedData) {
                      if (entry.extractedData.prompt) {
                          dataHtml += '<div class="ai-history-data"><strong>–ü—Ä–æ–º–ø—Ç:</strong> ' + escapeHtml(entry.extractedData.prompt) + '</div>';
                      }
                      if (entry.extractedData.chatHistory) {
                          dataHtml += '<div class="ai-history-data"><strong>–ò—Å—Ç–æ—Ä–∏—è:</strong> ' + escapeHtml(entry.extractedData.chatHistory) + '</div>';
                      }
                      if (entry.extractedData.filteredHistory) {
                          dataHtml += '<div class="ai-history-data"><strong>–§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è:</strong> ' + escapeHtml(entry.extractedData.filteredHistory) + '</div>';
                      }
                      if (entry.extractedData.error) {
                          dataHtml += '<div class="ai-history-data error"><strong>–û—à–∏–±–∫–∞:</strong> ' + escapeHtml(entry.extractedData.error) + '</div>';
                      }
                  }
                  
                  if (funcFile) {
                      dataHtml += '<div class="ai-func-file"><strong>–§—É–Ω–∫—Ü–∏—è:</strong> ' + escapeHtml(funcFile) + '</div>';
                  }
                  if (requestId) {
                      dataHtml += '<div class="ai-request-id"><strong>RequestID:</strong> ' + requestId + '</div>';
                  }
                  
                  return '<div class="ai-history-item ' + stageClass + '" onclick="showHistoryDetails(' + (group.startIndex + index) + ')">' +
                      (stageLabel ? '<div class="ai-stage-label">' + stageLabel + '</div>' : '') +
                      '<div class="ai-type">' + aiType + '</div>' +
                      '<div class="ai-history-status">' + entry.status + '</div>' +
                      '<div class="ai-status-description">' + getStatusDescription(entry.status) + '</div>' +
                      '<div class="ai-history-time">' + formatTime(entry.timestamp) + '</div>' +
                      '<div class="ai-history-logger">' + escapeHtml(entry.logger) + '</div>' +
                      dataHtml +
                  '</div>';
              }).join('');
              
              return '<div class="ai-history-group">' +
                  '<div class="ai-group-separator">' + (groupIndex > 0 ? '<hr>' : '') + '</div>' +
                  '<div class="ai-group-header">' + group.type + (group.requestId ? ' (ID: ' + group.requestId + ')' : '') + '</div>' +
                  groupHtml +
              '</div>';
          }).join('');
          
          container.innerHTML = 
              '<div class="ai-history-header">' +
                  '<h4>–ò—Å—Ç–æ—Ä–∏—è: "' + escapeHtml(message.content.substring(0, 50)) + (message.content.length > 50 ? '...' : '') + '"</h4>' +
              '</div>' +
              historyHtml;
      }
      
      function groupHistoryByAiRequests(history) {
          const groups = [];
          let currentGroup = null;
          
          history.forEach(function(entry, index) {
              const requestId = extractRequestId(entry.fullMessage);
              
              // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö AI –∑–∞–ø—Ä–æ—Å–æ–≤
              if (entry.status === 'MESSAGE_AI_REQUEST_START' || entry.status === 'JSON_AI_EXTRACT_START') {
                  if (currentGroup) {
                      groups.push(currentGroup);
                  }
                  currentGroup = {
                      events: [],
                      startIndex: index,
                      requestId: requestId,
                      type: entry.status.startsWith('MESSAGE_AI') ? 'Message AI' : 'JSON AI'
                  };
              }
              
              if (currentGroup) {
                  currentGroup.events.push(entry);
              } else {
                  // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã, —Å–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω–æ—á–Ω—É—é
                  groups.push({
                      events: [entry],
                      startIndex: index,
                      requestId: requestId,
                      type: 'Other'
                  });
              }
          });
          
          if (currentGroup) {
              groups.push(currentGroup);
          }
          
          return groups;
      }
      
      function showHistoryDetails(historyIndex) {
          const message = currentMessages[currentAiHistoryIndex];
          const entry = message.history[historyIndex];
          
          const detailsHtml = '<div class="ai-history-details">' + escapeHtml(entry.fullMessage) + '</div>';
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
          const items = document.querySelectorAll('.ai-history-item');
          items.forEach(function(item, index) {
              if (index === historyIndex) {
                  item.innerHTML = item.innerHTML.replace(/<div class="ai-history-details">.*?<\/div>/g, '') + detailsHtml;
              } else {
                  item.innerHTML = item.innerHTML.replace(/<div class="ai-history-details">.*?<\/div>/g, '');
              }
          });
      }
      
      function getStatusDescription(status) {
          const descriptions = {
              // Message AI –ª–æ–≥–∏
              'MESSAGE_AI_REQUEST_START': '–ù–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É AI',
              'MESSAGE_AI_REQUEST_HISTORY': '–°—ã—Ä–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ AI)',
              'MESSAGE_AI_SYSTEM_INSTRUCTION': '–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è + –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤',
              'MESSAGE_AI_FILTERED_HISTORY': '–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞, –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–∞—è –¥–ª—è AI',
              'MESSAGE_AI_GEMINI_REQUEST': '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ Gemini AI',
              'MESSAGE_AI_RAW_RESPONSE': '–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini AI',
              'MESSAGE_AI_RAW_TEXT': '–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç Gemini AI',
              'MESSAGE_AI_FINAL_RESULT': '–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ AI',
              'MESSAGE_AI_REQUEST_END': '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É AI',
              'MESSAGE_AI_REQUEST_EXCEPTION': '–û—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º AI',
              
              // JSON AI –ª–æ–≥–∏
              'JSON_AI_EXTRACT_START': '–ù–∞—á–∞–ª–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ AI',
              'JSON_AI_EXTRACT_INPUT': '–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç AI –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞',
              'JSON_AI_EXTRACT_STEP1': '–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä—è–º–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è JSON',
              'JSON_AI_EXTRACT_STEP2': 'JSON –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π, –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
              'JSON_AI_FIX_START': '–ù–∞—á–∞–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è JSON —á–µ—Ä–µ–∑ AI',
              'JSON_AI_FIX_PROMPT': '–ü—Ä–æ–º–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è JSON',
              'JSON_AI_FIX_RAW_RESPONSE': '–û—Ç–≤–µ—Ç AI –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è JSON',
              'JSON_AI_FIX_TEXT': '–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π JSON –æ—Ç AI',
              'JSON_AI_FIX_SUCCESS': 'JSON —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω',
              'JSON_AI_PARSE_INPUT': '–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞',
              'JSON_AI_PARSE_JSON_DATA': '–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ JSON –¥–∞–Ω–Ω—ã–µ',
              'JSON_AI_PARSE_USER_TEXT': '–¢–µ–∫—Å—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ JSON',
              'JSON_AI_PARSE_COMMAND': '–ö–æ–º–∞–Ω–¥–∞ –∏–∑ JSON',
              
              // Backend –ª–æ–≥–∏
              'WEBHOOK_AI_RESPONSE_TEXT': '–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é',
              'MESSAGE_SEND_INPUT': '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ',
              'MESSAGE_SEND_START': '–ù–∞—á–∞–ª–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è'
          };
          
          return descriptions[status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å';
      }
      
      function showUserHistory(messageIndex) {
          currentAiHistoryIndex = messageIndex;
          currentHistoryPage = 0;
          displayUserHistory();
      }
      
      function displayUserHistory() {
          const container = document.getElementById('ai-history-content');
          if (currentAiHistoryIndex === -1 || !currentMessages[currentAiHistoryIndex]) {
              container.innerHTML = '<div class="empty-state">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏</div>';
              return;
          }
          const message = currentMessages[currentAiHistoryIndex];
          if (!message.history || message.history.length === 0) {
              container.innerHTML = '<div class="empty-state">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</div>';
              return;
          }
          let replyHtml = '';
          if (message.replyTo) {
              // –ù–∞–π—Ç–∏ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ message_id (–µ—Å–ª–∏ –µ—Å—Ç—å)
              const original = currentMessages.find(m => m.message_id === message.replyTo);
              if (original) {
                  replyHtml = '<div class="user-reply-block">‚Ü©Ô∏è –û—Ç–≤–µ—Ç –Ω–∞: <span>' + escapeHtml(original.content) + '</span></div>';
              } else {
                  replyHtml = '<div class="user-reply-block">‚Ü©Ô∏è –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ ID: ' + escapeHtml(message.replyTo) + '</div>';
              }
          }
          const history = message.history;
          const historyHtml = history.map(function(entry, index) {
              let dataHtml = '';
              if (entry.extractedData) {
                  if (entry.extractedData.prompt) {
                      dataHtml += '<div class="ai-history-data"><strong>–ü—Ä–æ–º–ø—Ç:</strong> ' + escapeHtml(entry.extractedData.prompt) + '</div>';
                  }
                  if (entry.extractedData.chatHistory) {
                      dataHtml += '<div class="ai-history-data"><strong>–ò—Å—Ç–æ—Ä–∏—è:</strong> ' + escapeHtml(entry.extractedData.chatHistory) + '</div>';
                  }
                  if (entry.extractedData.filteredHistory) {
                      dataHtml += '<div class="ai-history-data"><strong>–§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è:</strong> ' + escapeHtml(entry.extractedData.filteredHistory) + '</div>';
                  }
                  if (entry.extractedData.error) {
                      dataHtml += '<div class="ai-history-data error"><strong>–û—à–∏–±–∫–∞:</strong> ' + escapeHtml(entry.extractedData.error) + '</div>';
                  }
              }
              return '<div class="ai-history-item" onclick="showHistoryDetails(' + index + ')">' +
                  '<div class="ai-history-status">' + entry.status + '</div>' +
                  '<div class="ai-status-description">' + getStatusDescription(entry.status) + '</div>' +
                  '<div class="ai-history-time">' + formatTime(entry.timestamp) + '</div>' +
                  '<div class="ai-history-logger">' + escapeHtml(entry.logger) + '</div>' +
                  dataHtml +
              '</div>';
          }).join('');
          container.innerHTML =
              '<div class="ai-history-header">' +
                  '<h4>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "' + escapeHtml(message.content.substring(0, 50)) + (message.content.length > 50 ? '...' : '') + '"</h4>' +
                  replyHtml +
              '</div>' +
              historyHtml;
      }
      

      
              document.addEventListener('DOMContentLoaded', function() {
            // loadLogsFromServer(); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ - —É–±—Ä–∞–Ω–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞
            // loadSessions(); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ - —É–±—Ä–∞–Ω–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞

          document.getElementById('loadLogsBtn').onclick = async function() {
              const period = parseInt(document.getElementById('logPeriodInput').value) || 20;
              console.log(`[DEBUG] –ó–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –ª–æ–≥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥: ${period} –º–∏–Ω—É—Ç`);
              try {
                  // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏
                  await loadLogsFromServer();
                  
                  // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Å—Å–∏–∏
                  await loadSessions();
                  
                  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª
                  await saveLogsToServer();
                  
                  console.log(`[DEBUG] –õ–æ–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, —Å–µ—Å—Å–∏–π: ${serverLogs.length}`);
              } catch (e) {
                  console.error('[DEBUG] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª–æ–≥–æ–≤:', e);
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª–æ–≥–æ–≤: ' + e);
              }
          };
          document.getElementById('newSessionIdBtn').onclick = async function() {
              if (!currentSessionId) {
                  alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
                  return;
              }
              const senderId = currentSessionId.split('_')[0];
              console.log(`[DEBUG] –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã session_id –Ω–∞–∂–∞—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${senderId}`);
              try {
                  const response = await fetch(`/session/${senderId}/new`, { method: 'POST' });
                  const data = await response.json();
                  if (data.session_id) {
                      await fetch(`/api/force_session/${senderId}`, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ session_id: data.session_id })
                      });
                      console.log(`[DEBUG] –ù–æ–≤—ã–π session_id –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ backend: ${data.session_id}`);
                      currentSessionId = data.session_id;
                      alert(`‚úÖ –ù–æ–≤—ã–π session_id –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${senderId}:\n${data.session_id}\n\n–¢–µ–ø–µ—Ä—å –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –±—É–¥—É—Ç –∏–¥—Ç–∏ —Å —ç—Ç–∏–º session_id, –ø–æ–∫–∞ –Ω–µ –≤—ã–±–µ—Ä–µ—Ç–µ –¥—Ä—É–≥—É—é —Å–µ—Å—Å–∏—é –∏–ª–∏ –Ω–µ –Ω–∞–∂–º—ë—Ç–µ –∫–Ω–æ–ø–∫—É —Å–Ω–æ–≤–∞.`);
                      selectSession(currentSessionId);
                  } else {
                      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ session_id!');
                  }
              } catch (e) {
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ session_id: ' + e);
              }
          };
      });

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      async function saveLogsToServer() {
          if (!serverLogs || serverLogs.length === 0) {
              return;
          }
          try {
              const response = await fetch(SERVER_URL + '/api/save_fresh_logs', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(serverLogs)
              });
              const result = await response.json();
              if (result.status === 'ok') {
                  console.log('–õ–æ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ fresh_logs.log');
              } else {
                  console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ª–æ–≥–æ–≤:', result.error);
              }
          } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–æ–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', e);
          }
      }
    </script>
</body>
</html> 