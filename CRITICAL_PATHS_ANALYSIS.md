# Анализ критических путей обработки сообщений

## Критический путь 1: Обработка текстового сообщения

### Этап 1: Получение и валидация webhook'а
```python
# Время выполнения: ~50-100ms
POST /webhook/ → WebhookHandler.process_webhook()

Критические проверки:
✅ Структура webhook (entry.changes.value)
✅ Тип сообщения (text, interactive, image)
✅ Дубликаты (кэш _processed_messages)
✅ Время сообщения (отложенные сообщения)

Возможные ошибки:
❌ Неверная структура webhook
❌ Неподдерживаемый тип сообщения
❌ Дубликат сообщения
❌ Сообщение старше 2 минут с более новым в истории
```

### Этап 2: Извлечение данных
```python
# Время выполнения: ~10-20ms
webhook_extractors.py

Извлекаемые поля:
- sender_id: body['entry'][0]['changes'][0]['value']['messages'][0]['from']
- message_text: body['entry'][0]['changes'][0]['value']['messages'][0]['text']['body']
- sender_name: body['entry'][0]['changes'][0]['value']['contacts'][0]['profile']['name']
- wa_message_id: body['entry'][0]['changes'][0]['value']['messages'][0]['id']
- timestamp: body['entry'][0]['changes'][0]['value']['messages'][0]['timestamp']

Критические ошибки:
❌ Отсутствует sender_id
❌ Отсутствует message_text
❌ Неверный формат timestamp
```

### Этап 3: Отправка статусов WhatsApp
```python
# Время выполнения: ~200-500ms (асинхронно)
MessageProcessor._send_status_updates()

Отправляемые статусы:
1. "read" - сообщение прочитано
2. "typing" - бот печатает

Критические моменты:
⚠️ Блокирующая операция (ждем ответа от WhatsApp API)
⚠️ Возможные таймауты (30 секунд)
⚠️ Ошибки сети
```

### Этап 4: Управление сессией
```python
# Время выполнения: ~100-300ms
SessionService.get_or_create_session_id()

Логика:
1. Проверка существующей сессии в users/{sender_id}
2. Валидация срока сессии (неделя)
3. Генерация нового session_id при необходимости
4. Сохранение в Firestore

Критические операции:
⚠️ Чтение из Firestore (users collection)
⚠️ Запись в Firestore при создании новой сессии
⚠️ Генерация уникального session_id
```

### Этап 5: Сохранение сообщения пользователя
```python
# Время выполнения: ~200-500ms
MessageService.add_message_with_transaction_sync()

Операции:
1. Определение языка (AI + fallback)
2. Перевод на 3 языка
3. Создание объекта Message
4. Сохранение в Firestore с транзакцией
5. Ограничение истории (10 сообщений)

Критические моменты:
⚠️ Вызов AI для определения языка (~1-3 секунды)
⚠️ Транзакция Firestore (чтение + запись)
⚠️ Ограничение истории (удаление старых сообщений)
```

### Этап 6: Получение истории диалога
```python
# Время выполнения: ~100-300ms
MessageService.get_conversation_history_for_ai_by_sender()

Операции:
1. Чтение из conversations/{sender_id}/sessions/{session_id}/messages
2. Ограничение: 50 последних сообщений
3. Форматирование для AI

Критические моменты:
⚠️ Чтение из Firestore (подколлекция messages)
⚠️ Сортировка по timestamp
⚠️ Ограничение размера (50 сообщений)
```

### Этап 7: Обработка через AI
```python
# Время выполнения: ~3-8 секунд (самый долгий этап)
AIService.generate_response()

Операции:
1. Создание системного промпта
2. Форматирование истории диалога
3. Вызов Gemini API
4. Парсинг JSON ответа
5. Извлечение текста и команд

Критические моменты:
⚠️ Вызов внешнего API (Gemini) - основной bottleneck
⚠️ Парсинг JSON ответа
⚠️ Обработка ошибок AI
⚠️ Fallback при недоступности AI
```

### Этап 8: Обработка команд
```python
# Время выполнения: ~500ms-2 секунды
CommandService.handle_command()

Возможные команды:
- send_catalog: отправка каталога (~1-3 секунды)
- save_order_info: сохранение данных заказа (~200ms)
- add_order_item: добавление товара (~200ms)
- confirm_order: подтверждение заказа (~500ms)

Критические операции:
⚠️ Отправка каталога (множественные API вызовы)
⚠️ Транзакции с заказами
⚠️ Валидация товаров через каталог
```

### Этап 9: Отправка ответа
```python
# Время выполнения: ~200-500ms
MessageProcessor._send_ai_response()

Операции:
1. Создание сообщения AI
2. Сохранение в БД
3. Отправка через WhatsApp API
4. Повторные попытки при ошибках (до 3 раз)

Критические моменты:
⚠️ Блокирующий вызов WhatsApp API
⚠️ Повторные попытки при ошибках
⚠️ Сохранение в БД
```

## Критический путь 2: Отправка каталога

### Этап 1: Получение товаров
```python
# Время выполнения: ~500ms-1 секунда
CatalogService.get_available_products()

Операции:
1. Вызов WhatsApp Business API для получения каталога
2. Фильтрация доступных товаров
3. Подготовка данных для отправки

Критические моменты:
⚠️ Внешний API вызов
⚠️ Фильтрация по availability
⚠️ Обработка ошибок API
```

### Этап 2: Отправка товаров
```python
# Время выполнения: ~2-5 секунд (зависит от количества товаров)
CatalogSender.send_catalog()

Для каждого товара:
1. Подготовка изображения + caption
2. Отправка через WhatsApp API
3. Сохранение в историю диалога

Критические моменты:
⚠️ Множественные API вызовы
⚠️ Размер изображений
⚠️ Ограничения WhatsApp API
```

## Критический путь 3: Обработка заказа

### Этап 1: Создание/обновление заказа
```python
# Время выполнения: ~200-500ms
OrderService.get_or_create_order()

Операции:
1. Проверка существующего заказа
2. Создание нового заказа при необходимости
3. Сохранение в Firestore

Критические моменты:
⚠️ Транзакция Firestore
⚠️ Уникальность order_id (session_id)
```

### Этап 2: Добавление товара
```python
# Время выполнения: ~300-800ms
OrderService.add_item()

Операции:
1. Валидация товара через каталог
2. Создание OrderItem
3. Добавление в заказ
4. Обновление в Firestore

Критические моменты:
⚠️ Валидация через внешний API
⚠️ Транзакция обновления заказа
```

## Анализ производительности

### Временные характеристики:

| Этап | Минимальное время | Максимальное время | Критичность |
|------|------------------|-------------------|-------------|
| Валидация webhook | 50ms | 100ms | Низкая |
| Извлечение данных | 10ms | 20ms | Низкая |
| Статусы WhatsApp | 200ms | 500ms | Средняя |
| Управление сессией | 100ms | 300ms | Средняя |
| Сохранение сообщения | 200ms | 500ms | Средняя |
| Получение истории | 100ms | 300ms | Средняя |
| **AI обработка** | **3s** | **8s** | **Высокая** |
| Обработка команд | 500ms | 2s | Средняя |
| Отправка ответа | 200ms | 500ms | Средняя |

### Общее время обработки:
- **Минимальное**: ~4.5 секунды
- **Максимальное**: ~12 секунд
- **Среднее**: ~8 секунд

### Bottlenecks:
1. **AI обработка** (Gemini API) - 40-70% времени
2. **Отправка каталога** - 20-40% времени
3. **Статусы WhatsApp** - 5-10% времени

## Рекомендации по оптимизации

### 1. Кэширование AI ответов
```python
# Кэширование частых запросов
- Кэш системных промптов
- Кэш переводов
- Кэш определений языка
```

### 2. Асинхронная обработка
```python
# Параллельное выполнение:
- Отправка статусов (не блокирует основной поток)
- Сохранение в БД (асинхронно)
- Логирование (не блокирует)
```

### 3. Оптимизация AI
```python
# Сокращение времени AI:
- Уменьшение размера промпта
- Ограничение истории диалога
- Использование более быстрой модели
```

### 4. Batch операции
```python
# Группировка операций:
- Batch сохранение сообщений
- Batch отправка статусов
- Batch обновления заказов
```

### 5. Мониторинг производительности
```python
# Метрики для отслеживания:
- Время каждого этапа
- Количество ошибок
- Размер очереди
- Использование ресурсов
```

## Критические точки отказа

### 1. WhatsApp Business API
```python
# Риски:
- Таймауты API
- Ограничения rate limit
- Недоступность сервиса

# Стратегии:
- Повторные попытки
- Circuit breaker
- Fallback сообщения
```

### 2. Gemini AI API
```python
# Риски:
- Таймауты API
- Ограничения токенов
- Недоступность сервиса

# Стратегии:
- Fallback промпты
- Кэширование ответов
- Graceful degradation
```

### 3. Firestore
```python
# Риски:
- Таймауты БД
- Ограничения транзакций
- Недоступность сервиса

# Стратегии:
- Retry логика
- Batch операции
- Offline кэш
```

### 4. Сеть
```python
# Риски:
- Потеря соединения
- Высокая задержка
- Нестабильность

# Стратегии:
- Таймауты соединения
- Повторные попытки
- Health checks
``` 